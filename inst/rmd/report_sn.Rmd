---
title: "FJP Dados"
subtitle: "Segurança Alimentar"
author:
  - name: "Coordenação de Indicadores Sociais (CIS)"
    affiliation: "Diretoria de Estatística e Informações (Direi)"
    address: "Alameda das Acácias, 70 - São Luiz"
    city: "Belo Horizonte"
    state: "Minas Gerais"
    postal_code: "31.275-150"
    url: "https://fjp.mg.gov.br/"
lang: pt
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
description: "Relatório contendo uma análise descritiva e os resultados das regras de crítica dos dados da dimensão."
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: false
    df_print: kable
    fig_caption: true
    table_caption: true
    embed-resources: true
    smooth-scroll: true
    toc-location: left
    toc-title: MENU
    theme: journal
editor: visual
execute:
  echo: false
  warning: false
  error: false
  message: false
params:
  data: file.xlsx
output-file: "relatorio_sn.html"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r set_param_global}
k <- 1.2
```

```{r import_data}

data <- openxlsx::read.xlsx(params$data)
data$ANO <- as.character(data$ANO)
```

```{r get_var_numeric}

# Obter as siglas das variáveis do tipo numérico
var_numeric <- data |> 
  dplyr::select(
    !c("CHAVE", "IBGE6", "IBGE7", "ANO") & dplyr::where(is.numeric)
  ) |> 
  colnames() |> 
  unlist()
```

```{r get_var_character}

# Obter as siglas variáveis do tipo string
var_char <- data |> 
  dplyr::select(
    !c("CHAVE", "IBGE6", "IBGE7", "ANO") & dplyr::where(is.character)
  ) |> 
  colnames() |> 
  unlist()
```

# Introdução

A **crítica de dados** refere-se ao processo de verificação e validação da integridade dos dados. Esse processo é crucial para garantir a qualidade dos dados antes de serem utilizados para análises ou publicizados. A importância da crítica de dados reside na sua capacidade de identificar valores suspeitos ou inconsistências que poderiam comprometer a confiabilidade dos resultados obtidos a partir desses dados.

# Regras de crítica

As **regras de crítica** são diretrizes ou critérios específicos estabelecidos para avaliar se os dados atendem aos padrões de qualidade desejados. Essas regras podem incluir a verificação de intervalos de valores aceitáveis, a consistência lógica entre diferentes variáveis, e a detecção de valores ausentes, entre outras. Aplicar essas regras de maneira sistemática ajuda a assegurar que os dados sejam precisos, completos e adequados para seu propósito, promovendo a confiança nas análises e nas decisões baseadas em dados.

A padronização dos nomes permite que seja possível a identificação da classificação da regra e a presença do atributo de flexibilidade. Define-se a seguinte proposta de nomenclatura para as regras de crítica:

*1 carácter indicando finalidade + 1 carácter indicando flexibilidade + Sigla da variável*

**Classificação por finalidade**

Tipo (T): refere-se a classe da variável, são realizadas verificações no sentido de identificar se os dados são numéricos, caracteres, lógicos, entre outros.

-   **TI\_**[...]: tipo do dado está de acordo com o esperado (numérico, textual ou categórico).

Validade ou Intervalo (V): refere-se aos intervalos estabelecidos matematicamente para um dado ou indicador. Verificações de valores positivos, intervalos entre 0 e 1, são exemplos de verificação de validades, além da verificação de valores ausentes;

-   **VI_NA\_**[...]: dado não tem valor ausente/*missing*;

-   **VI\_**[...]: dado é não negativo, está devidamente categorizado ou está entre o intervalo esperado (ex.: 0% e 100%).

Consistência (C): refere-se aos casos em que se verificam as relações matemáticas com outras variáveis, por exemplo, parcelas de um total não podem ser maiores do que o próprio total.

-   **CF\_[...]\_total_year**: a soma da proporção anual é igual a $\approx$ 100%.

Distribuição (D): regras de distribuição estabelecem parâmetros esperados para as estatísticas descritivas da variável como média, mediana, máximo, mínimo e regras de identificação de *outliers*;

-   **DF\_[...]\_hampel_munic**: método de identificação de um possível valor *outlier* na série histórica;

-   **DF\_[...]\_out_munic**: segundo método de identificação de um possível valor *outlier* na série histórica;

-   **DF\_[...]\_min_munic**: o valor mais recente é maior ou igual ao menor valor da série histórica;

-   **DF\_[...]\_max_munic**: o valor mais recente é menor ou igual ao maior valor da série histórica;

-   **DF\_[...]\_min_k_munic**: o valor mais recente é maior ou igual ao $\dfrac{menor}{k}$ valor da série histórica;

-   **DF\_[...]\_max_k_munic**: o valor mais recente é menor ou igual ao $maior \times k$ valor da série histórica;

-   **DF\_[...]\_med_mov_munic**: o valor atual é menor ou igual a $mediana ~móvel \times k$;

-   **DF\_[...]\_dif_munic**: o valor mais recente da primeira diferença é menor ou igual ao maior valor da primeira diferença da série histórica;

-   **DF\_[...]\_estoque_munic**: valor atual é maior ou igual ao valor imediatamente anterior.

**Classificação por flexibilidade (F ou I)**

-   Flexível (F): construída com parâmetros esperados, mas caso algum caso falhe a regra, precisa ser investigado o motivo, identificando se é o caso de um valor atípico explicado por alguma situação.

-   Inflexível (I): necessariamente precisa ser seguida, uma regra inflexível é rígida e não existe exceção a sua condição estipulada.

```{r set_year}

# Inserir aqui apenas aquelas variáveis que possuem alguma restrição 
# no ano inicial de análise devido a fatores como mudança de metodologia
ano_base_alter <- c(
   "SN_BAIXO_PESO_NASCER"            = 2019,
   "SN_COR_TOTAL"                    = 2019,
   "SN_COR_BAIXOPESO"                = 2019,
   "SN_RECURSO_PAA"                  = 2019,
   "SN_MEDIA_RECURSO_AGRICULTOR_PAA" = 2019,
   "SN_MULHERES_PAA_SOMA"            = 2019,
   "SN_AGRICULTOR_PAA_CADUNICO"      = 2019,
   "SN_DEMANDA_PAA"                  = 2019,
   "SN_REPASSE_AGRIC_PNAE"           = 2016,
   "SN_ESCOLAS_PNAE"                 = 2016,
   "SN_RAZAO_NUTRI"                  = 2019,
   "SN_ESCOLAS_POTAVEL"              = 2016,
   "SN_MEDIA_ARMAZEM"                = 2016,
   "SN_MEDIA_ARMAZEM_NORM"           = 2016,
   "SN_ENERGIA_ESCOLAS"              = 2016,
   "SN_VULNERABILIDADE_ESCOLAS"      = 2016,
   "SN_AGUA_ESCOLAS"                 = 2016,
   "SN_ESGOTO_ESCOLAS"               = 2016,
   "SN_LIXO_ESCOLAS"                 = 2016,
   "SN_TRABAGRICU"                   = 2014,
   "SN_TRABAGRIMUL"                  = 2014
)

# Remover os comentários para utilizar este trecho caso não haja nenhuma restrição
# para nenhuma variável
# ano_base_alter <- c(
#   "NA" = NA_integer_
# )

exclusions_years <- c(
   "SN_BAIXO_PESO_NASCER"            = c(2024),
   "SN_COR_TOTAL"                    = c(2024),
   "SN_COR_BAIXOPESO"                = c(2024),
   "SN_REPASSE_AGRIC_PNAE"           = c(2020,2021,2023,2024),
   "SN_ESCOLAS_PNAE"                 = c(2020,2021,2024),
   "SN_RAZAO_NUTRI"                  = c(2020,2021,2024),
   "SN_ESCOLAS_POTAVEL"              = c(2020,2021,2024),
   "SN_MEDIA_ARMAZEM"                = c(2020,2021,2024),
   "SN_MEDIA_ARMAZEM_NORM"           = c(2020,2021,2024),
   "SN_ENERGIA_ESCOLAS"              = c(2020,2021,2024),
   "SN_VULNERABILIDADE_ESCOLAS"      = c(2020,2021,2024),
   "SN_AGUA_ESCOLAS"                 = c(2020,2021,2024),
   "SN_ESGOTO_ESCOLAS"               = c(2020,2021,2024),
   "SN_LIXO_ESCOLAS"                 = c(2020,2021,2024),
   "SN_TRABAGRICU"                   = c(2024),
   "SN_TRABAGRIMUL"                  = c(2024)
  )

```

```{r get_cat}

## Categorias variáveis dicotômicas
cat_dic <- c(
  1,
  0
)

```

```{r map_valid_desc}

# Mapear variável e descrição de sua respectiva regra de validade para ser apresentado na tabela.
desc_regra_valid <- c(
  # Casos mais comuns
  `1`  = "Valor é ≥ 0",
  `2`  = "Valor está dentro da categoria esperada",
  `3`  = "Valor está dentro da faixa esperada (0 a 100)"
)

# df com o nome da regra e a respectiva descrição
desc_regra_valid_var <- data.frame(
  Regra = c(
    "VI_SN_BAIXO_PESO_NASCER",
    "VI_SN_COR_TOTAL",
    "VI_SN_COR_BAIXOPESO",
    "VI_SN_RECURSO_PAA",
    "VI_SN_MEDIA_RECURSO_AGRICULTOR_PAA",
    "VI_SN_MULHERES_PAA_SOMA",
    "VI_SN_ADESAO_PAA",
    "VI_SN_AGRICULTOR_PAA_CADUNICO",
    "VI_SN_DEMANDA_PAA",
    "VI_SN_REPASSE_AGRIC_PNAE",
    "VI_SN_ESCOLAS_PNAE",
    "VI_SN_RAZAO_NUTRI",
    "VI_SN_ESCOLAS_POTAVEL",
    "VI_SN_MEDIA_ARMAZEM",
    "VI_SN_MEDIA_ARMAZEM_NORM",
    "VI_SN_ENERGIA_ESCOLAS",
    "VI_SN_VULNERABILIDADE_ESCOLAS",
    "VI_SN_AGUA_ESCOLAS",
    "VI_SN_ESGOTO_ESCOLAS",
    "VI_SN_LIXO_ESCOLAS",
    "VI_SN_TRABAGRICU",
    "VI_SN_TRABAGRIMUL"
  )
) |> 
  dplyr::mutate(
    `Descrição` = dplyr::case_match(
      Regra,
      "VI_SN_BAIXO_PESO_NASCER"                 ~ desc_regra_valid[3],
      "VI_SN_COR_TOTAL"                         ~ desc_regra_valid[3],
      "VI_SN_COR_BAIXOPESO"                     ~ desc_regra_valid[3],
      "VI_SN_RECURSO_PAA"                       ~ desc_regra_valid[1],
      "VI_SN_MEDIA_RECURSO_AGRICULTOR_PAA"      ~ desc_regra_valid[1],
      "VI_SN_MULHERES_PAA_SOMA"                 ~ desc_regra_valid[3],
      "VI_SN_ADESAO_PAA"                        ~ desc_regra_valid[2],
      "VI_SN_AGRICULTOR_PAA_CADUNICO"           ~ desc_regra_valid[3],
      "VI_SN_DEMANDA_PAA"                       ~ desc_regra_valid[1],
      "VI_SN_REPASSE_AGRIC_PNAE"                ~ desc_regra_valid[3],
      "VI_SN_ESCOLAS_PNAE"                      ~ desc_regra_valid[3],
      "VI_SN_RAZAO_NUTRI"                       ~ desc_regra_valid[1],
      "VI_SN_ESCOLAS_POTAVEL"                   ~ desc_regra_valid[3],
      "VI_SN_MEDIA_ARMAZEM"                     ~ desc_regra_valid[1],
      "VI_SN_MEDIA_ARMAZEM_NORM"                ~ desc_regra_valid[1],
      "VI_SN_ENERGIA_ESCOLAS"                   ~ desc_regra_valid[3],
      "VI_SN_VULNERABILIDADE_ESCOLAS"           ~ desc_regra_valid[3],
      "VI_SN_AGUA_ESCOLAS"                      ~ desc_regra_valid[3],
      "VI_SN_ESGOTO_ESCOLAS"                    ~ desc_regra_valid[3],
      "VI_SN_LIXO_ESCOLAS"                      ~ desc_regra_valid[3],
      "VI_SN_TRABAGRICU"                        ~ desc_regra_valid[3],
      "VI_SN_TRABAGRIMUL"                       ~ desc_regra_valid[3]
    )
  )
```


## Tipo

### Todos os indicadores

```{r rules_type}
  
rules_type <- validate::validator(
  TI_SN_BAIXO_PESO_NASCER            = is.numeric(SN_BAIXO_PESO_NASCER), 
  TI_SN_COR_TOTAL                    = is.numeric(SN_COR_TOTAL),
  TI_SN_COR_BAIXOPESO                = is.numeric(SN_COR_BAIXOPESO),
  TI_SN_RECURSO_PAA                  = is.numeric(SN_RECURSO_PAA), 
  TI_SN_MEDIA_RECURSO_AGRICULTOR_PAA = is.numeric(SN_MEDIA_RECURSO_AGRICULTOR_PAA), 
  TI_SN_MULHERES_PAA_SOMA            = is.numeric(SN_MULHERES_PAA_SOMA), 
  TI_SN_ADESAO_PAA                   = is.numeric(SN_ADESAO_PAA), 
  TI_SN_AGRICULTOR_PAA_CADUNICO      = is.numeric(SN_AGRICULTOR_PAA_CADUNICO), 
  TI_SN_DEMANDA_PAA                  = is.numeric(SN_DEMANDA_PAA), 
  TI_SN_REPASSE_AGRIC_PNAE           = is.numeric(SN_REPASSE_AGRIC_PNAE), 
  TI_SN_ESCOLAS_PNAE                 = is.numeric(SN_ESCOLAS_PNAE), 
  TI_SN_RAZAO_NUTRI                  = is.numeric(SN_RAZAO_NUTRI),
  TI_SN_ESCOLAS_POTAVEL              = is.numeric(SN_ESCOLAS_POTAVEL), 
  TI_SN_MEDIA_ARMAZEM                = is.numeric(SN_MEDIA_ARMAZEM),
  TI_SN_MEDIA_ARMAZEM_NORM           = is.numeric(SN_MEDIA_ARMAZEM_NORM),
  TI_SN_ENERGIA_ESCOLAS              = is.numeric(SN_ENERGIA_ESCOLAS), 
  TI_SN_VULNERABILIDADE_ESCOLAS      = is.numeric(SN_VULNERABILIDADE_ESCOLAS), 
  TI_SN_AGUA_ESCOLAS                 = is.numeric(SN_AGUA_ESCOLAS), 
  TI_SN_ESGOTO_ESCOLAS               = is.numeric(SN_ESGOTO_ESCOLAS), 
  TI_SN_LIXO_ESCOLAS                 = is.numeric(SN_LIXO_ESCOLAS), 
  TI_SN_TRABAGRICU                   = is.numeric(SN_TRABAGRICU), 
  TI_SN_TRABAGRIMUL                  = is.numeric(SN_TRABAGRIMUL)
)
```

```{r confront_type}

## Confrontar os dados com as regras e exibir uma tabela com os resultados
check_type <- validate::confront(data, rules_type)

validate::summary(check_type) |> 
  dplyr::select(
    Regra    = name,
    Validada = passes
  ) |> 
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |>
  kableExtra::kable_paper("hover", full_width = F)
```

## Validade

```{r data_rules_valid_sn_all}

## df com o resultado das aplicações das regras
df_rules_valid_sn_all <- data |> 
  dplyr::select(
    Ano   = ANO, 
    ibge7 = IBGE7, 
    dplyr::starts_with("SN_")
  ) |> 
  dplyr::mutate(
    # Missing
    VI_NA_SN_BAIXO_PESO_NASCER            = dplyr::if_else(!is.na(SN_BAIXO_PESO_NASCER), F, T),
    VI_NA_SN_COR_TOTAL                    = dplyr::if_else(!is.na(SN_COR_TOTAL), F, T),
    VI_NA_SN_COR_BAIXOPESO                = dplyr::if_else(!is.na(SN_COR_BAIXOPESO), F, T),
    VI_NA_SN_RECURSO_PAA                  = dplyr::if_else(!is.na(SN_RECURSO_PAA), F, T),
    VI_NA_SN_MEDIA_RECURSO_AGRICULTOR_PAA = dplyr::if_else(!is.na(SN_MEDIA_RECURSO_AGRICULTOR_PAA), F, T),
    VI_NA_SN_MULHERES_PAA_SOMA            = dplyr::if_else(!is.na(SN_MULHERES_PAA_SOMA), F, T),
    VI_NA_SN_ADESAO_PAA                   = dplyr::if_else(!is.na(SN_ADESAO_PAA), F, T),
    VI_NA_SN_AGRICULTOR_PAA_CADUNICO      = dplyr::if_else(!is.na(SN_AGRICULTOR_PAA_CADUNICO), F, T),
    VI_NA_SN_DEMANDA_PAA                  = dplyr::if_else(!is.na(SN_DEMANDA_PAA), F, T),
    VI_NA_SN_REPASSE_AGRIC_PNAE           = dplyr::if_else(!is.na(SN_REPASSE_AGRIC_PNAE), F, T),
    VI_NA_SN_ESCOLAS_PNAE                 = dplyr::if_else(!is.na(SN_ESCOLAS_PNAE), F, T),
    VI_NA_SN_ESCOLAS_POTAVEL              = dplyr::if_else(!is.na(SN_ESCOLAS_POTAVEL), F, T),
    VI_NA_SN_ENERGIA_ESCOLAS              = dplyr::if_else(!is.na(SN_ENERGIA_ESCOLAS), F, T),
    VI_NA_SN_VULNERABILIDADE_ESCOLAS      = dplyr::if_else(!is.na(SN_VULNERABILIDADE_ESCOLAS), F, T),
    VI_NA_SN_AGUA_ESCOLAS                 = dplyr::if_else(!is.na(SN_AGUA_ESCOLAS), F, T),
    VI_NA_SN_ESGOTO_ESCOLAS               = dplyr::if_else(!is.na(SN_ESGOTO_ESCOLAS), F, T),
    VI_NA_SN_LIXO_ESCOLAS                 = dplyr::if_else(!is.na(SN_LIXO_ESCOLAS), F, T),
    VI_NA_SN_TRABAGRICU                   = dplyr::if_else(!is.na(SN_TRABAGRICU), F, T),
    VI_NA_SN_TRABAGRIMUL                  = dplyr::if_else(!is.na(SN_TRABAGRIMUL), F, T),
    
    # Others
    VI_SN_BAIXO_PESO_NASCER  = dplyr::if_else(dplyr::between(SN_BAIXO_PESO_NASCER, 0, 100), F, T),
    VI_SN_COR_TOTAL          = dplyr::if_else(dplyr::between(SN_COR_TOTAL, 0, 100), F, T),
    VI_SN_COR_BAIXOPESO      = dplyr::if_else(dplyr::between(SN_COR_BAIXOPESO, 0, 100), F, T),
    VI_SN_RECURSO_PAA        = dplyr::if_else(SN_RECURSO_PAA >= 0, F, T),
    VI_SN_MEDIA_RECURSO_AGRICULTOR_PAA = dplyr::if_else(SN_MEDIA_RECURSO_AGRICULTOR_PAA >= 0, F, T),
    VI_SN_MULHERES_PAA_SOMA       = dplyr::if_else(dplyr::between(SN_MULHERES_PAA_SOMA, 0, 100), F, T),
    VI_SN_ADESAO_PAA              = dplyr::if_else(SN_ADESAO_PAA %in% cat_dic, F, T),
    VI_SN_AGRICULTOR_PAA_CADUNICO = dplyr::if_else(dplyr::between(SN_AGRICULTOR_PAA_CADUNICO, 0, 100), F, T),
    VI_SN_DEMANDA_PAA             = dplyr::if_else(SN_DEMANDA_PAA>= 0, F, T),
    VI_SN_REPASSE_AGRIC_PNAE      = dplyr::if_else(dplyr::between(SN_REPASSE_AGRIC_PNAE, 0, 100), F, T),
    VI_SN_ESCOLAS_PNAE            = dplyr::if_else(dplyr::between(SN_ESCOLAS_PNAE, 0, 100), F, T),
    VI_SN_RAZAO_NUTRI             = dplyr::if_else(SN_RAZAO_NUTRI >= 0, F, T),
    VI_SN_ESCOLAS_POTAVEL         = dplyr::if_else(dplyr::between(SN_ESCOLAS_POTAVEL, 0, 100), F, T),
    VI_SN_MEDIA_ARMAZEM           = dplyr::if_else(SN_MEDIA_ARMAZEM >= 0, F, T),
    VI_SN_MEDIA_ARMAZEM_NORM      = dplyr::if_else(SN_MEDIA_ARMAZEM_NORM >= 0, F, T),
    VI_SN_ENERGIA_ESCOLAS         = dplyr::if_else(dplyr::between(SN_ENERGIA_ESCOLAS, 0, 100), F, T),
    VI_SN_VULNERABILIDADE_ESCOLAS = dplyr::if_else(dplyr::between(SN_VULNERABILIDADE_ESCOLAS, 0, 100), F, T),
    VI_SN_AGUA_ESCOLAS            = dplyr::if_else(dplyr::between(SN_AGUA_ESCOLAS, 0, 100), F, T),
    VI_SN_ESGOTO_ESCOLAS          = dplyr::if_else(dplyr::between(SN_ESGOTO_ESCOLAS, 0, 100), F, T),
    VI_SN_LIXO_ESCOLAS            = dplyr::if_else(dplyr::between(SN_LIXO_ESCOLAS, 0, 100), F, T),
    VI_SN_TRABAGRICU              = dplyr::if_else(dplyr::between(SN_TRABAGRICU, 0, 100), F, T),
    VI_SN_TRABAGRIMUL             = dplyr::if_else(dplyr::between(SN_TRABAGRIMUL, 0, 100), F, T)
  )
data$SN_ADESAO_PAA <- as.character(data$SN_ADESAO_PAA)
var_char <- data |> 
  dplyr::select(
    !c("CHAVE", "IBGE6", "IBGE7", "ANO") & dplyr::where(is.character)
  ) |> 
  colnames() |> 
  unlist()
var_numeric <- var_numeric[var_numeric != var_char]
```

```{r data_wrangling_valid_sn_all}

## Transformação dos resultados
df_sumario_valid_sn <- df_rules_valid_sn_all |>
  dplyr::select(Ano,
                ibge7,
                dplyr::starts_with(c("VI_", "VI_NA"))) |>
  tidyr::pivot_longer(cols = !c(Ano, ibge7),
                      names_to = "Regra",
                      values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_valid_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(resultado),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

### Todos os indicadores - Valores ausentes

```{r table_valid_sn_na_all}
df_sumario |>
  dplyr::select(Ano, Regra, Total, contains("Suspeita")) |>
  dplyr::filter(
    Ano == max(Ano) & 
    stringr::str_detect(Regra, "_NA_")
  ) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  dplyr::rename(Ausente = Suspeita, `% Ausente` = `% Suspeita`) |>
  dplyr::mutate(`% Ausente` = ifelse(is.infinite(`% Ausente`),100,`% Ausente`)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

### Todos os indicadores - Demais regras

```{r table_valid_sn_all}
#| column: screen-inset-right
df_sumario |>
  dplyr::filter(
    Ano == max(Ano) & 
    stringr::str_detect(Regra, "_NA_", negate = T)
  ) |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  dplyr::left_join(desc_regra_valid_var, by = dplyr::join_by(Regra)) |>  # Introdução coluna descrição
  unique() |> 
  dplyr::select(-c(Ausente,`% Ausente`))|> 
  dplyr::mutate( `% Suspeita`= ifelse(is.na(`% Suspeita`),0,`% Suspeita`))|>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```


## Distribuição

### SN_BAIXO_PESO_NASCER

```{r data_rules_dist_SN_BAIXO_PESO_NASCER}

## df com o resultado das aplicações das regras
df_rules_dist_SN_BAIXO_PESO_NASCER <- data |> 
  remove_year_variable(variable = "SN_BAIXO_PESO_NASCER", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_BAIXO_PESO_NASCER" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_BAIXO_PESO_NASCER"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_BAIXO_PESO_NASCER) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_BAIXO_PESO_NASCER_hampel_munic  = dplyr::if_else(!hampel_filter(SN_BAIXO_PESO_NASCER), F, T), # Longitudinal (município)
    
    DF_SN_BAIXO_PESO_NASCER_out_munic     = dplyr::if_else(!outlier_function(SN_BAIXO_PESO_NASCER), F, T), # Longitudinal (município)
    
    DF_SN_BAIXO_PESO_NASCER_min_munic     = dplyr::if_else(SN_BAIXO_PESO_NASCER >= (min(dplyr::lag(SN_BAIXO_PESO_NASCER), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_BAIXO_PESO_NASCER_max_munic     = dplyr::if_else(SN_BAIXO_PESO_NASCER <= (max(dplyr::lag(SN_BAIXO_PESO_NASCER), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_BAIXO_PESO_NASCER_min_k_munic   = dplyr::if_else(SN_BAIXO_PESO_NASCER >= (min(dplyr::lag(SN_BAIXO_PESO_NASCER), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_BAIXO_PESO_NASCER_max_k_munic   = dplyr::if_else(SN_BAIXO_PESO_NASCER <= (k * max(dplyr::lag(SN_BAIXO_PESO_NASCER), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_BAIXO_PESO_NASCER_med_mov_munic = dplyr::if_else(SN_BAIXO_PESO_NASCER <= (k * zoo::rollmedian(SN_BAIXO_PESO_NASCER, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_BAIXO_PESO_NASCER_dif_munic     = dplyr::if_else(!compare_first_dif(SN_BAIXO_PESO_NASCER), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_BAIXO_PESO_NASCER}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_BAIXO_PESO_NASCER |> 
  dplyr::select(!SN_BAIXO_PESO_NASCER) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()

df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_BAIXO_PESO_NASCER}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)

```

```{r chart_dist_SN_BAIXO_PESO_NASCER}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```




### SN_COR_TOTAL

```{r data_rules_dist_SN_COR_TOTAL}

## df com o resultado das aplicações das regras
df_rules_dist_SN_COR_TOTAL <- data |> 
  remove_year_variable(variable = "SN_COR_TOTAL", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_COR_TOTAL" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_COR_TOTAL"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_COR_TOTAL) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_COR_TOTAL_hampel_munic  = dplyr::if_else(!hampel_filter(SN_COR_TOTAL), F, T), # Longitudinal (município)
    
    DF_SN_COR_TOTAL_out_munic     = dplyr::if_else(!outlier_function(SN_COR_TOTAL), F, T), # Longitudinal (município)
    
    DF_SN_COR_TOTAL_min_munic     = dplyr::if_else(SN_COR_TOTAL >= (min(dplyr::lag(SN_COR_TOTAL), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_COR_TOTAL_max_munic     = dplyr::if_else(SN_COR_TOTAL <= (max(dplyr::lag(SN_COR_TOTAL), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_COR_TOTAL_min_k_munic   = dplyr::if_else(SN_COR_TOTAL >= (min(dplyr::lag(SN_COR_TOTAL), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_COR_TOTAL_max_k_munic   = dplyr::if_else(SN_COR_TOTAL <= (k * max(dplyr::lag(SN_COR_TOTAL), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_COR_TOTAL_med_mov_munic = dplyr::if_else(SN_COR_TOTAL <= (k * zoo::rollmedian(SN_COR_TOTAL, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_COR_TOTAL_dif_munic     = dplyr::if_else(!compare_first_dif(SN_COR_TOTAL), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_COR_TOTAL}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_COR_TOTAL |> 
  dplyr::select(!SN_COR_TOTAL) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()

```

```{r table_dist_SN_COR_TOTAL}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_COR_TOTAL}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```







### SN_COR_BAIXOPESO

```{r data_rules_dist_SN_COR_BAIXOPESO}

## df com o resultado das aplicações das regras
df_rules_dist_SN_COR_BAIXOPESO <- data |> 
  remove_year_variable(variable = "SN_COR_BAIXOPESO", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_COR_BAIXOPESO" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_COR_BAIXOPESO"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_COR_BAIXOPESO) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_COR_BAIXOPESO_hampel_munic  = dplyr::if_else(!hampel_filter(SN_COR_BAIXOPESO), F, T), # Longitudinal (município)
    
    DF_SN_COR_BAIXOPESO_out_munic     = dplyr::if_else(!outlier_function(SN_COR_BAIXOPESO), F, T), # Longitudinal (município)
    
    DF_SN_COR_BAIXOPESO_min_munic     = dplyr::if_else(SN_COR_BAIXOPESO >= (min(dplyr::lag(SN_COR_BAIXOPESO), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_COR_BAIXOPESO_max_munic     = dplyr::if_else(SN_COR_BAIXOPESO <= (max(dplyr::lag(SN_COR_BAIXOPESO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_COR_BAIXOPESO_min_k_munic   = dplyr::if_else(SN_COR_BAIXOPESO >= (min(dplyr::lag(SN_COR_BAIXOPESO), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_COR_BAIXOPESO_max_k_munic   = dplyr::if_else(SN_COR_BAIXOPESO <= (k * max(dplyr::lag(SN_COR_BAIXOPESO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_COR_BAIXOPESO_med_mov_munic = dplyr::if_else(SN_COR_BAIXOPESO <= (k * zoo::rollmedian(SN_COR_BAIXOPESO, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_COR_BAIXOPESO_dif_munic     = dplyr::if_else(!compare_first_dif(SN_COR_BAIXOPESO), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_COR_BAIXOPESO}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_COR_BAIXOPESO |> 
  dplyr::select(!SN_COR_BAIXOPESO) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_COR_BAIXOPESO}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_COR_BAIXOPESO}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```









### SN_RECURSO_PAA

```{r data_rules_dist_SN_RECURSO_PAA}

## df com o resultado das aplicações das regras
df_rules_dist_SN_RECURSO_PAA <- data |> 
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_RECURSO_PAA" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_RECURSO_PAA"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_RECURSO_PAA) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_RECURSO_PAA_hampel_munic  = dplyr::if_else(!hampel_filter(SN_RECURSO_PAA), F, T), # Longitudinal (município)
    
    DF_SN_RECURSO_PAA_out_munic     = dplyr::if_else(!outlier_function(SN_RECURSO_PAA), F, T), # Longitudinal (município)
    
    DF_SN_RECURSO_PAA_min_munic     = dplyr::if_else(SN_RECURSO_PAA >= (min(dplyr::lag(SN_RECURSO_PAA), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_RECURSO_PAA_max_munic     = dplyr::if_else(SN_RECURSO_PAA <= (max(dplyr::lag(SN_RECURSO_PAA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_RECURSO_PAA_min_k_munic   = dplyr::if_else(SN_RECURSO_PAA >= (min(dplyr::lag(SN_RECURSO_PAA), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_RECURSO_PAA_max_k_munic   = dplyr::if_else(SN_RECURSO_PAA <= (k * max(dplyr::lag(SN_RECURSO_PAA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_RECURSO_PAA_med_mov_munic = dplyr::if_else(SN_RECURSO_PAA <= (k * zoo::rollmedian(SN_RECURSO_PAA, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_RECURSO_PAA_dif_munic     = dplyr::if_else(!compare_first_dif(SN_RECURSO_PAA), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_RECURSO_PAA}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_RECURSO_PAA |> 
  dplyr::select(!SN_RECURSO_PAA) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_RECURSO_PAA}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_RECURSO_PAA}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```




### SN_MEDIA_RECURSO_AGRICULTOR_PAA

```{r data_rules_dist_SN_MEDIA_RECURSO_AGRICULTOR_PAA}

## df com o resultado das aplicações das regras
df_rules_dist_SN_MEDIA_RECURSO_AGRICULTOR_PAA <- data |> 
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_MEDIA_RECURSO_AGRICULTOR_PAA" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_MEDIA_RECURSO_AGRICULTOR_PAA"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_MEDIA_RECURSO_AGRICULTOR_PAA) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_MEDIA_RECURSO_AGRICULTOR_PAA_hampel_munic  = dplyr::if_else(!hampel_filter(SN_MEDIA_RECURSO_AGRICULTOR_PAA), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_RECURSO_AGRICULTOR_PAA_out_munic     = dplyr::if_else(!outlier_function(SN_MEDIA_RECURSO_AGRICULTOR_PAA), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_RECURSO_AGRICULTOR_PAA_min_munic     = dplyr::if_else(SN_MEDIA_RECURSO_AGRICULTOR_PAA >= (min(dplyr::lag(SN_MEDIA_RECURSO_AGRICULTOR_PAA), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_MEDIA_RECURSO_AGRICULTOR_PAA_max_munic     = dplyr::if_else(SN_MEDIA_RECURSO_AGRICULTOR_PAA <= (max(dplyr::lag(SN_MEDIA_RECURSO_AGRICULTOR_PAA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_RECURSO_AGRICULTOR_PAA_min_k_munic   = dplyr::if_else(SN_MEDIA_RECURSO_AGRICULTOR_PAA >= (min(dplyr::lag(SN_MEDIA_RECURSO_AGRICULTOR_PAA), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_MEDIA_RECURSO_AGRICULTOR_PAA_max_k_munic   = dplyr::if_else(SN_MEDIA_RECURSO_AGRICULTOR_PAA <= (k * max(dplyr::lag(SN_MEDIA_RECURSO_AGRICULTOR_PAA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_RECURSO_AGRICULTOR_PAA_med_mov_munic = dplyr::if_else(SN_MEDIA_RECURSO_AGRICULTOR_PAA <= (k * zoo::rollmedian(SN_MEDIA_RECURSO_AGRICULTOR_PAA, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_RECURSO_AGRICULTOR_PAA_dif_munic     = dplyr::if_else(!compare_first_dif(SN_MEDIA_RECURSO_AGRICULTOR_PAA), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_MEDIA_RECURSO_AGRICULTOR_PAA}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_MEDIA_RECURSO_AGRICULTOR_PAA |> 
  dplyr::select(!SN_MEDIA_RECURSO_AGRICULTOR_PAA) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_MEDIA_RECURSO_AGRICULTOR_PAA}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_MEDIA_RECURSO_AGRICULTOR_PAA}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```








### SN_MULHERES_PAA_SOMA

```{r data_rules_dist_SN_MULHERES_PAA_SOMA}

## df com o resultado das aplicações das regras
df_rules_dist_SN_MULHERES_PAA_SOMA <- data |> 
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_MULHERES_PAA_SOMA" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_MULHERES_PAA_SOMA"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_MULHERES_PAA_SOMA) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_MULHERES_PAA_SOMA_hampel_munic  = dplyr::if_else(!hampel_filter(SN_MULHERES_PAA_SOMA), F, T), # Longitudinal (município)
    
    DF_SN_MULHERES_PAA_SOMA_out_munic     = dplyr::if_else(!outlier_function(SN_MULHERES_PAA_SOMA), F, T), # Longitudinal (município)
    
    DF_SN_MULHERES_PAA_SOMA_min_munic     = dplyr::if_else(SN_MULHERES_PAA_SOMA >= (min(dplyr::lag(SN_MULHERES_PAA_SOMA), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_MULHERES_PAA_SOMA_max_munic     = dplyr::if_else(SN_MULHERES_PAA_SOMA <= (max(dplyr::lag(SN_MULHERES_PAA_SOMA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_MULHERES_PAA_SOMA_min_k_munic   = dplyr::if_else(SN_MULHERES_PAA_SOMA >= (min(dplyr::lag(SN_MULHERES_PAA_SOMA), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_MULHERES_PAA_SOMA_max_k_munic   = dplyr::if_else(SN_MULHERES_PAA_SOMA <= (k * max(dplyr::lag(SN_MULHERES_PAA_SOMA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_MULHERES_PAA_SOMA_med_mov_munic = dplyr::if_else(SN_MULHERES_PAA_SOMA <= (k * zoo::rollmedian(SN_MULHERES_PAA_SOMA, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_MULHERES_PAA_SOMA_dif_munic     = dplyr::if_else(!compare_first_dif(SN_MULHERES_PAA_SOMA), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_MULHERES_PAA_SOMA}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_MULHERES_PAA_SOMA |> 
  dplyr::select(!SN_MULHERES_PAA_SOMA) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_MULHERES_PAA_SOMA}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_MULHERES_PAA_SOMA}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```









### SN_AGRICULTOR_PAA_CADUNICO

```{r data_rules_dist_SN_AGRICULTOR_PAA_CADUNICO}

## df com o resultado das aplicações das regras
df_rules_dist_SN_AGRICULTOR_PAA_CADUNICO <- data |> 
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_AGRICULTOR_PAA_CADUNICO" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_AGRICULTOR_PAA_CADUNICO"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_AGRICULTOR_PAA_CADUNICO) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_AGRICULTOR_PAA_CADUNICO_hampel_munic  = dplyr::if_else(!hampel_filter(SN_AGRICULTOR_PAA_CADUNICO), F, T), # Longitudinal (município)
    
    DF_SN_AGRICULTOR_PAA_CADUNICO_out_munic     = dplyr::if_else(!outlier_function(SN_AGRICULTOR_PAA_CADUNICO), F, T), # Longitudinal (município)
    
    DF_SN_AGRICULTOR_PAA_CADUNICO_min_munic     = dplyr::if_else(SN_AGRICULTOR_PAA_CADUNICO >= (min(dplyr::lag(SN_AGRICULTOR_PAA_CADUNICO), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_AGRICULTOR_PAA_CADUNICO_max_munic     = dplyr::if_else(SN_AGRICULTOR_PAA_CADUNICO <= (max(dplyr::lag(SN_AGRICULTOR_PAA_CADUNICO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_AGRICULTOR_PAA_CADUNICO_min_k_munic   = dplyr::if_else(SN_AGRICULTOR_PAA_CADUNICO >= (min(dplyr::lag(SN_AGRICULTOR_PAA_CADUNICO), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_AGRICULTOR_PAA_CADUNICO_max_k_munic   = dplyr::if_else(SN_AGRICULTOR_PAA_CADUNICO <= (k * max(dplyr::lag(SN_AGRICULTOR_PAA_CADUNICO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_AGRICULTOR_PAA_CADUNICO_med_mov_munic = dplyr::if_else(SN_AGRICULTOR_PAA_CADUNICO <= (k * zoo::rollmedian(SN_AGRICULTOR_PAA_CADUNICO, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_AGRICULTOR_PAA_CADUNICO_dif_munic     = dplyr::if_else(!compare_first_dif(SN_AGRICULTOR_PAA_CADUNICO), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_AGRICULTOR_PAA_CADUNICO}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_AGRICULTOR_PAA_CADUNICO |> 
  dplyr::select(!SN_AGRICULTOR_PAA_CADUNICO) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_AGRICULTOR_PAA_CADUNICO}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_AGRICULTOR_PAA_CADUNICO}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```





### SN_DEMANDA_PAA

```{r data_rules_dist_SN_DEMANDA_PAA}

## df com o resultado das aplicações das regras
df_rules_dist_SN_DEMANDA_PAA <- data |> 
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_DEMANDA_PAA" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_DEMANDA_PAA"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_DEMANDA_PAA) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_DEMANDA_PAA_hampel_munic  = dplyr::if_else(!hampel_filter(SN_DEMANDA_PAA), F, T), # Longitudinal (município)
    
    DF_SN_DEMANDA_PAA_out_munic     = dplyr::if_else(!outlier_function(SN_DEMANDA_PAA), F, T), # Longitudinal (município)
    
    DF_SN_DEMANDA_PAA_min_munic     = dplyr::if_else(SN_DEMANDA_PAA >= (min(dplyr::lag(SN_DEMANDA_PAA), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_DEMANDA_PAA_max_munic     = dplyr::if_else(SN_DEMANDA_PAA <= (max(dplyr::lag(SN_DEMANDA_PAA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_DEMANDA_PAA_min_k_munic   = dplyr::if_else(SN_DEMANDA_PAA >= (min(dplyr::lag(SN_DEMANDA_PAA), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_DEMANDA_PAA_max_k_munic   = dplyr::if_else(SN_DEMANDA_PAA <= (k * max(dplyr::lag(SN_DEMANDA_PAA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_DEMANDA_PAA_med_mov_munic = dplyr::if_else(SN_DEMANDA_PAA <= (k * zoo::rollmedian(SN_DEMANDA_PAA, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_DEMANDA_PAA_dif_munic     = dplyr::if_else(!compare_first_dif(SN_DEMANDA_PAA), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_DEMANDA_PAA}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_DEMANDA_PAA |> 
  dplyr::select(!SN_DEMANDA_PAA) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_DEMANDA_PAA}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_DEMANDA_PAA}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```



### SN_REPASSE_AGRIC_PNAE

```{r data_rules_dist_SN_REPASSE_AGRIC_PNAE}

## df com o resultado das aplicações das regras
df_rules_dist_SN_REPASSE_AGRIC_PNAE <- data |> 
  remove_year_variable(variable = "SN_REPASSE_AGRIC_PNAE", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_REPASSE_AGRIC_PNAE" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_REPASSE_AGRIC_PNAE"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_REPASSE_AGRIC_PNAE) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_REPASSE_AGRIC_PNAE_hampel_munic  = dplyr::if_else(!hampel_filter(SN_REPASSE_AGRIC_PNAE), F, T), # Longitudinal (município)
    
    DF_SN_REPASSE_AGRIC_PNAE_out_munic     = dplyr::if_else(!outlier_function(SN_REPASSE_AGRIC_PNAE), F, T), # Longitudinal (município)
    
    DF_SN_REPASSE_AGRIC_PNAE_min_munic     = dplyr::if_else(SN_REPASSE_AGRIC_PNAE >= (min(dplyr::lag(SN_REPASSE_AGRIC_PNAE), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_REPASSE_AGRIC_PNAE_max_munic     = dplyr::if_else(SN_REPASSE_AGRIC_PNAE <= (max(dplyr::lag(SN_REPASSE_AGRIC_PNAE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_REPASSE_AGRIC_PNAE_min_k_munic   = dplyr::if_else(SN_REPASSE_AGRIC_PNAE >= (min(dplyr::lag(SN_REPASSE_AGRIC_PNAE), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_REPASSE_AGRIC_PNAE_max_k_munic   = dplyr::if_else(SN_REPASSE_AGRIC_PNAE <= (k * max(dplyr::lag(SN_REPASSE_AGRIC_PNAE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_REPASSE_AGRIC_PNAE_med_mov_munic = dplyr::if_else(SN_REPASSE_AGRIC_PNAE <= (k * zoo::rollmedian(SN_REPASSE_AGRIC_PNAE, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_REPASSE_AGRIC_PNAE_dif_munic     = dplyr::if_else(!compare_first_dif(SN_REPASSE_AGRIC_PNAE), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_REPASSE_AGRIC_PNAE}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_REPASSE_AGRIC_PNAE |> 
  dplyr::select(!SN_REPASSE_AGRIC_PNAE) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_REPASSE_AGRIC_PNAE}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_REPASSE_AGRIC_PNAE}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```



### SN_ESCOLAS_PNAE

```{r data_rules_dist_SN_ESCOLAS_PNAE}

## df com o resultado das aplicações das regras
df_rules_dist_SN_ESCOLAS_PNAE <- data |> 
  remove_year_variable(variable = "SN_ESCOLAS_PNAE", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_ESCOLAS_PNAE" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_ESCOLAS_PNAE"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_ESCOLAS_PNAE) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_ESCOLAS_PNAE_hampel_munic  = dplyr::if_else(!hampel_filter(SN_ESCOLAS_PNAE), F, T), # Longitudinal (município)
    
    DF_SN_ESCOLAS_PNAE_out_munic     = dplyr::if_else(!outlier_function(SN_ESCOLAS_PNAE), F, T), # Longitudinal (município)
    
    DF_SN_ESCOLAS_PNAE_min_munic     = dplyr::if_else(SN_ESCOLAS_PNAE >= (min(dplyr::lag(SN_ESCOLAS_PNAE), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_ESCOLAS_PNAE_max_munic     = dplyr::if_else(SN_ESCOLAS_PNAE <= (max(dplyr::lag(SN_ESCOLAS_PNAE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_ESCOLAS_PNAE_min_k_munic   = dplyr::if_else(SN_ESCOLAS_PNAE >= (min(dplyr::lag(SN_ESCOLAS_PNAE), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_ESCOLAS_PNAE_max_k_munic   = dplyr::if_else(SN_ESCOLAS_PNAE <= (k * max(dplyr::lag(SN_ESCOLAS_PNAE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_ESCOLAS_PNAE_med_mov_munic = dplyr::if_else(SN_ESCOLAS_PNAE <= (k * zoo::rollmedian(SN_ESCOLAS_PNAE, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_ESCOLAS_PNAE_dif_munic     = dplyr::if_else(!compare_first_dif(SN_ESCOLAS_PNAE), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_ESCOLAS_PNAE}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_ESCOLAS_PNAE |> 
  dplyr::select(!SN_ESCOLAS_PNAE) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_ESCOLAS_PNAE}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_ESCOLAS_PNAE}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```



### SN_RAZAO_NUTRI

```{r data_rules_dist_SN_RAZAO_NUTRI}

## df com o resultado das aplicações das regras
df_rules_dist_SN_RAZAO_NUTRI <- data |> 
  remove_year_variable(variable = "SN_RAZAO_NUTRI", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_RAZAO_NUTRI" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_RAZAO_NUTRI"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_RAZAO_NUTRI) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_RAZAO_NUTRI_hampel_munic  = dplyr::if_else(!hampel_filter(SN_RAZAO_NUTRI), F, T), # Longitudinal (município)
    
    DF_SN_RAZAO_NUTRI_out_munic     = dplyr::if_else(!outlier_function(SN_RAZAO_NUTRI), F, T), # Longitudinal (município)
    
    DF_SN_RAZAO_NUTRI_min_munic     = dplyr::if_else(SN_RAZAO_NUTRI >= (min(dplyr::lag(SN_RAZAO_NUTRI), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_RAZAO_NUTRI_max_munic     = dplyr::if_else(SN_RAZAO_NUTRI <= (max(dplyr::lag(SN_RAZAO_NUTRI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_RAZAO_NUTRI_min_k_munic   = dplyr::if_else(SN_RAZAO_NUTRI >= (min(dplyr::lag(SN_RAZAO_NUTRI), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_RAZAO_NUTRI_max_k_munic   = dplyr::if_else(SN_RAZAO_NUTRI <= (k * max(dplyr::lag(SN_RAZAO_NUTRI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_RAZAO_NUTRI_med_mov_munic = dplyr::if_else(SN_RAZAO_NUTRI <= (k * zoo::rollmedian(SN_RAZAO_NUTRI, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_RAZAO_NUTRI_dif_munic     = dplyr::if_else(!compare_first_dif(SN_RAZAO_NUTRI), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_RAZAO_NUTRI}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_RAZAO_NUTRI |> 
  dplyr::select(!SN_RAZAO_NUTRI) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_RAZAO_NUTRI}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_RAZAO_NUTRI}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```


### SN_ESCOLAS_POTAVEL

```{r data_rules_dist_SN_ESCOLAS_POTAVEL}

## df com o resultado das aplicações das regras
df_rules_dist_SN_ESCOLAS_POTAVEL <- data |> 
  remove_year_variable(variable = "SN_ESCOLAS_POTAVEL", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_ESCOLAS_POTAVEL" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_ESCOLAS_POTAVEL"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_ESCOLAS_POTAVEL) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_ESCOLAS_POTAVEL_hampel_munic  = dplyr::if_else(!hampel_filter(SN_ESCOLAS_POTAVEL), F, T), # Longitudinal (município)
    
    DF_SN_ESCOLAS_POTAVEL_out_munic     = dplyr::if_else(!outlier_function(SN_ESCOLAS_POTAVEL), F, T), # Longitudinal (município)
    
    DF_SN_ESCOLAS_POTAVEL_min_munic     = dplyr::if_else(SN_ESCOLAS_POTAVEL >= (min(dplyr::lag(SN_ESCOLAS_POTAVEL), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_ESCOLAS_POTAVEL_max_munic     = dplyr::if_else(SN_ESCOLAS_POTAVEL <= (max(dplyr::lag(SN_ESCOLAS_POTAVEL), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_ESCOLAS_POTAVEL_min_k_munic   = dplyr::if_else(SN_ESCOLAS_POTAVEL >= (min(dplyr::lag(SN_ESCOLAS_POTAVEL), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_ESCOLAS_POTAVEL_max_k_munic   = dplyr::if_else(SN_ESCOLAS_POTAVEL <= (k * max(dplyr::lag(SN_ESCOLAS_POTAVEL), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_ESCOLAS_POTAVEL_med_mov_munic = dplyr::if_else(SN_ESCOLAS_POTAVEL <= (k * zoo::rollmedian(SN_ESCOLAS_POTAVEL, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_ESCOLAS_POTAVEL_dif_munic     = dplyr::if_else(!compare_first_dif(SN_ESCOLAS_POTAVEL), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_ESCOLAS_POTAVEL}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_ESCOLAS_POTAVEL |> 
  dplyr::select(!SN_ESCOLAS_POTAVEL) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_ESCOLAS_POTAVEL}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_ESCOLAS_POTAVEL}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```


### SN_MEDIA_ARMAZEM

```{r data_rules_dist_SN_MEDIA_ARMAZEM}

## df com o resultado das aplicações das regras
df_rules_dist_SN_MEDIA_ARMAZEM <- data |> 
  remove_year_variable(variable = "SN_MEDIA_ARMAZEM", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_MEDIA_ARMAZEM" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_MEDIA_ARMAZEM"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_MEDIA_ARMAZEM) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_MEDIA_ARMAZEM_hampel_munic  = dplyr::if_else(!hampel_filter(SN_MEDIA_ARMAZEM), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_ARMAZEM_out_munic     = dplyr::if_else(!outlier_function(SN_MEDIA_ARMAZEM), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_ARMAZEM_min_munic     = dplyr::if_else(SN_MEDIA_ARMAZEM >= (min(dplyr::lag(SN_MEDIA_ARMAZEM), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_MEDIA_ARMAZEM_max_munic     = dplyr::if_else(SN_MEDIA_ARMAZEM <= (max(dplyr::lag(SN_MEDIA_ARMAZEM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_ARMAZEM_min_k_munic   = dplyr::if_else(SN_MEDIA_ARMAZEM >= (min(dplyr::lag(SN_MEDIA_ARMAZEM), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_MEDIA_ARMAZEM_max_k_munic   = dplyr::if_else(SN_MEDIA_ARMAZEM <= (k * max(dplyr::lag(SN_MEDIA_ARMAZEM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_ARMAZEM_med_mov_munic = dplyr::if_else(SN_MEDIA_ARMAZEM <= (k * zoo::rollmedian(SN_MEDIA_ARMAZEM, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_ARMAZEM_dif_munic     = dplyr::if_else(!compare_first_dif(SN_MEDIA_ARMAZEM), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_MEDIA_ARMAZEM}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_MEDIA_ARMAZEM |> 
  dplyr::select(!SN_MEDIA_ARMAZEM) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_MEDIA_ARMAZEM}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_MEDIA_ARMAZEM}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```


### SN_MEDIA_ARMAZEM_NORM

```{r data_rules_dist_SN_MEDIA_ARMAZEM_NORM}

## df com o resultado das aplicações das regras
df_rules_dist_SN_MEDIA_ARMAZEM_NORM <- data |> 
  remove_year_variable(variable = "SN_MEDIA_ARMAZEM_NORM", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_MEDIA_ARMAZEM_NORM" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_MEDIA_ARMAZEM_NORM"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_MEDIA_ARMAZEM_NORM) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_MEDIA_ARMAZEM_NORM_hampel_munic  = dplyr::if_else(!hampel_filter(SN_MEDIA_ARMAZEM_NORM), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_ARMAZEM_NORM_out_munic     = dplyr::if_else(!outlier_function(SN_MEDIA_ARMAZEM_NORM), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_ARMAZEM_NORM_min_munic     = dplyr::if_else(SN_MEDIA_ARMAZEM_NORM >= (min(dplyr::lag(SN_MEDIA_ARMAZEM_NORM), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_MEDIA_ARMAZEM_NORM_max_munic     = dplyr::if_else(SN_MEDIA_ARMAZEM_NORM <= (max(dplyr::lag(SN_MEDIA_ARMAZEM_NORM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_ARMAZEM_NORM_min_k_munic   = dplyr::if_else(SN_MEDIA_ARMAZEM_NORM >= (min(dplyr::lag(SN_MEDIA_ARMAZEM_NORM), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_MEDIA_ARMAZEM_NORM_max_k_munic   = dplyr::if_else(SN_MEDIA_ARMAZEM_NORM <= (k * max(dplyr::lag(SN_MEDIA_ARMAZEM_NORM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_ARMAZEM_NORM_med_mov_munic = dplyr::if_else(SN_MEDIA_ARMAZEM_NORM <= (k * zoo::rollmedian(SN_MEDIA_ARMAZEM_NORM, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_MEDIA_ARMAZEM_NORM_dif_munic     = dplyr::if_else(!compare_first_dif(SN_MEDIA_ARMAZEM_NORM), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_MEDIA_ARMAZEM_NORM}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_MEDIA_ARMAZEM_NORM |> 
  dplyr::select(!SN_MEDIA_ARMAZEM_NORM) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_MEDIA_ARMAZEM_NORM}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_MEDIA_ARMAZEM_NORM}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```


### SN_ENERGIA_ESCOLAS

```{r data_rules_dist_SN_ENERGIA_ESCOLAS}

## df com o resultado das aplicações das regras
df_rules_dist_SN_ENERGIA_ESCOLAS <- data |> 
  remove_year_variable(variable = "SN_ENERGIA_ESCOLAS", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_ENERGIA_ESCOLAS" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_ENERGIA_ESCOLAS"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_ENERGIA_ESCOLAS) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_ENERGIA_ESCOLAS_hampel_munic  = dplyr::if_else(!hampel_filter(SN_ENERGIA_ESCOLAS), F, T), # Longitudinal (município)
    
    DF_SN_ENERGIA_ESCOLAS_out_munic     = dplyr::if_else(!outlier_function(SN_ENERGIA_ESCOLAS), F, T), # Longitudinal (município)
    
    DF_SN_ENERGIA_ESCOLAS_min_munic     = dplyr::if_else(SN_ENERGIA_ESCOLAS >= (min(dplyr::lag(SN_ENERGIA_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_ENERGIA_ESCOLAS_max_munic     = dplyr::if_else(SN_ENERGIA_ESCOLAS <= (max(dplyr::lag(SN_ENERGIA_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_ENERGIA_ESCOLAS_min_k_munic   = dplyr::if_else(SN_ENERGIA_ESCOLAS >= (min(dplyr::lag(SN_ENERGIA_ESCOLAS), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_ENERGIA_ESCOLAS_max_k_munic   = dplyr::if_else(SN_ENERGIA_ESCOLAS <= (k * max(dplyr::lag(SN_ENERGIA_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_ENERGIA_ESCOLAS_med_mov_munic = dplyr::if_else(SN_ENERGIA_ESCOLAS <= (k * zoo::rollmedian(SN_ENERGIA_ESCOLAS, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_ENERGIA_ESCOLAS_dif_munic     = dplyr::if_else(!compare_first_dif(SN_ENERGIA_ESCOLAS), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_ENERGIA_ESCOLAS}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_ENERGIA_ESCOLAS |> 
  dplyr::select(!SN_ENERGIA_ESCOLAS) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_ENERGIA_ESCOLAS}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_ENERGIA_ESCOLAS}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```


### SN_VULNERABILIDADE_ESCOLAS

```{r data_rules_dist_SN_VULNERABILIDADE_ESCOLAS}

## df com o resultado das aplicações das regras
df_rules_dist_SN_VULNERABILIDADE_ESCOLAS <- data |> 
  remove_year_variable(variable = "SN_VULNERABILIDADE_ESCOLAS", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_VULNERABILIDADE_ESCOLAS" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_VULNERABILIDADE_ESCOLAS"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_VULNERABILIDADE_ESCOLAS) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_VULNERABILIDADE_ESCOLAS_hampel_munic  = dplyr::if_else(!hampel_filter(SN_VULNERABILIDADE_ESCOLAS), F, T), # Longitudinal (município)
    
    DF_SN_VULNERABILIDADE_ESCOLAS_out_munic     = dplyr::if_else(!outlier_function(SN_VULNERABILIDADE_ESCOLAS), F, T), # Longitudinal (município)
    
    DF_SN_VULNERABILIDADE_ESCOLAS_min_munic     = dplyr::if_else(SN_VULNERABILIDADE_ESCOLAS >= (min(dplyr::lag(SN_VULNERABILIDADE_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_VULNERABILIDADE_ESCOLAS_max_munic     = dplyr::if_else(SN_VULNERABILIDADE_ESCOLAS <= (max(dplyr::lag(SN_VULNERABILIDADE_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_VULNERABILIDADE_ESCOLAS_min_k_munic   = dplyr::if_else(SN_VULNERABILIDADE_ESCOLAS >= (min(dplyr::lag(SN_VULNERABILIDADE_ESCOLAS), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_VULNERABILIDADE_ESCOLAS_max_k_munic   = dplyr::if_else(SN_VULNERABILIDADE_ESCOLAS <= (k * max(dplyr::lag(SN_VULNERABILIDADE_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_VULNERABILIDADE_ESCOLAS_med_mov_munic = dplyr::if_else(SN_VULNERABILIDADE_ESCOLAS <= (k * zoo::rollmedian(SN_VULNERABILIDADE_ESCOLAS, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_VULNERABILIDADE_ESCOLAS_dif_munic     = dplyr::if_else(!compare_first_dif(SN_VULNERABILIDADE_ESCOLAS), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_VULNERABILIDADE_ESCOLAS}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_VULNERABILIDADE_ESCOLAS |> 
  dplyr::select(!SN_VULNERABILIDADE_ESCOLAS) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_VULNERABILIDADE_ESCOLAS}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_VULNERABILIDADE_ESCOLAS}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```


### SN_AGUA_ESCOLAS

```{r data_rules_dist_SN_AGUA_ESCOLAS}

## df com o resultado das aplicações das regras
df_rules_dist_SN_AGUA_ESCOLAS <- data |> 
  remove_year_variable(variable = "SN_AGUA_ESCOLAS", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_AGUA_ESCOLAS" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_AGUA_ESCOLAS"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_AGUA_ESCOLAS) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_AGUA_ESCOLAS_hampel_munic  = dplyr::if_else(!hampel_filter(SN_AGUA_ESCOLAS), F, T), # Longitudinal (município)
    
    DF_SN_AGUA_ESCOLAS_out_munic     = dplyr::if_else(!outlier_function(SN_AGUA_ESCOLAS), F, T), # Longitudinal (município)
    
    DF_SN_AGUA_ESCOLAS_min_munic     = dplyr::if_else(SN_AGUA_ESCOLAS >= (min(dplyr::lag(SN_AGUA_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_AGUA_ESCOLAS_max_munic     = dplyr::if_else(SN_AGUA_ESCOLAS <= (max(dplyr::lag(SN_AGUA_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_AGUA_ESCOLAS_min_k_munic   = dplyr::if_else(SN_AGUA_ESCOLAS >= (min(dplyr::lag(SN_AGUA_ESCOLAS), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_AGUA_ESCOLAS_max_k_munic   = dplyr::if_else(SN_AGUA_ESCOLAS <= (k * max(dplyr::lag(SN_AGUA_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_AGUA_ESCOLAS_med_mov_munic = dplyr::if_else(SN_AGUA_ESCOLAS <= (k * zoo::rollmedian(SN_AGUA_ESCOLAS, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_AGUA_ESCOLAS_dif_munic     = dplyr::if_else(!compare_first_dif(SN_AGUA_ESCOLAS), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_AGUA_ESCOLAS}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_AGUA_ESCOLAS |> 
  dplyr::select(!SN_AGUA_ESCOLAS) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_AGUA_ESCOLAS}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_AGUA_ESCOLAS}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```


### SN_ESGOTO_ESCOLAS

```{r data_rules_dist_SN_ESGOTO_ESCOLAS}

## df com o resultado das aplicações das regras
df_rules_dist_SN_ESGOTO_ESCOLAS <- data |> 
  remove_year_variable(variable = "SN_ESGOTO_ESCOLAS", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_ESGOTO_ESCOLAS" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_ESGOTO_ESCOLAS"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_ESGOTO_ESCOLAS) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_ESGOTO_ESCOLAS_hampel_munic  = dplyr::if_else(!hampel_filter(SN_ESGOTO_ESCOLAS), F, T), # Longitudinal (município)
    
    DF_SN_ESGOTO_ESCOLAS_out_munic     = dplyr::if_else(!outlier_function(SN_ESGOTO_ESCOLAS), F, T), # Longitudinal (município)
    
    DF_SN_ESGOTO_ESCOLAS_min_munic     = dplyr::if_else(SN_ESGOTO_ESCOLAS >= (min(dplyr::lag(SN_ESGOTO_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_ESGOTO_ESCOLAS_max_munic     = dplyr::if_else(SN_ESGOTO_ESCOLAS <= (max(dplyr::lag(SN_ESGOTO_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_ESGOTO_ESCOLAS_min_k_munic   = dplyr::if_else(SN_ESGOTO_ESCOLAS >= (min(dplyr::lag(SN_ESGOTO_ESCOLAS), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_ESGOTO_ESCOLAS_max_k_munic   = dplyr::if_else(SN_ESGOTO_ESCOLAS <= (k * max(dplyr::lag(SN_ESGOTO_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_ESGOTO_ESCOLAS_med_mov_munic = dplyr::if_else(SN_ESGOTO_ESCOLAS <= (k * zoo::rollmedian(SN_ESGOTO_ESCOLAS, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_ESGOTO_ESCOLAS_dif_munic     = dplyr::if_else(!compare_first_dif(SN_ESGOTO_ESCOLAS), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_ESGOTO_ESCOLAS}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_ESGOTO_ESCOLAS |> 
  dplyr::select(!SN_ESGOTO_ESCOLAS) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_ESGOTO_ESCOLAS}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_ESGOTO_ESCOLAS}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```


### SN_LIXO_ESCOLAS

```{r data_rules_dist_SN_LIXO_ESCOLAS}

## df com o resultado das aplicações das regras
df_rules_dist_SN_LIXO_ESCOLAS <- data |> 
  remove_year_variable(variable = "SN_LIXO_ESCOLAS", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_LIXO_ESCOLAS" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_LIXO_ESCOLAS"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_LIXO_ESCOLAS) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_LIXO_ESCOLAS_hampel_munic  = dplyr::if_else(!hampel_filter(SN_LIXO_ESCOLAS), F, T), # Longitudinal (município)
    
    DF_SN_LIXO_ESCOLAS_out_munic     = dplyr::if_else(!outlier_function(SN_LIXO_ESCOLAS), F, T), # Longitudinal (município)
    
    DF_SN_LIXO_ESCOLAS_min_munic     = dplyr::if_else(SN_LIXO_ESCOLAS >= (min(dplyr::lag(SN_LIXO_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_LIXO_ESCOLAS_max_munic     = dplyr::if_else(SN_LIXO_ESCOLAS <= (max(dplyr::lag(SN_LIXO_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_LIXO_ESCOLAS_min_k_munic   = dplyr::if_else(SN_LIXO_ESCOLAS >= (min(dplyr::lag(SN_LIXO_ESCOLAS), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_LIXO_ESCOLAS_max_k_munic   = dplyr::if_else(SN_LIXO_ESCOLAS <= (k * max(dplyr::lag(SN_LIXO_ESCOLAS), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_LIXO_ESCOLAS_med_mov_munic = dplyr::if_else(SN_LIXO_ESCOLAS <= (k * zoo::rollmedian(SN_LIXO_ESCOLAS, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_LIXO_ESCOLAS_dif_munic     = dplyr::if_else(!compare_first_dif(SN_LIXO_ESCOLAS), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_LIXO_ESCOLAS}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_LIXO_ESCOLAS |> 
  dplyr::select(!SN_LIXO_ESCOLAS) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_LIXO_ESCOLAS}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_LIXO_ESCOLAS}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```


### SN_TRABAGRICU

```{r data_rules_dist_SN_TRABAGRICU}

## df com o resultado das aplicações das regras
df_rules_dist_SN_TRABAGRICU <- data |> 
  remove_year_variable(variable = "SN_TRABAGRICU", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_TRABAGRICU" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_TRABAGRICU"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_TRABAGRICU) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_TRABAGRICU_hampel_munic  = dplyr::if_else(!hampel_filter(SN_TRABAGRICU), F, T), # Longitudinal (município)
    
    DF_SN_TRABAGRICU_out_munic     = dplyr::if_else(!outlier_function(SN_TRABAGRICU), F, T), # Longitudinal (município)
    
    DF_SN_TRABAGRICU_min_munic     = dplyr::if_else(SN_TRABAGRICU >= (min(dplyr::lag(SN_TRABAGRICU), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_TRABAGRICU_max_munic     = dplyr::if_else(SN_TRABAGRICU <= (max(dplyr::lag(SN_TRABAGRICU), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_TRABAGRICU_min_k_munic   = dplyr::if_else(SN_TRABAGRICU >= (min(dplyr::lag(SN_TRABAGRICU), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_TRABAGRICU_max_k_munic   = dplyr::if_else(SN_TRABAGRICU <= (k * max(dplyr::lag(SN_TRABAGRICU), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_TRABAGRICU_med_mov_munic = dplyr::if_else(SN_TRABAGRICU <= (k * zoo::rollmedian(SN_TRABAGRICU, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_TRABAGRICU_dif_munic     = dplyr::if_else(!compare_first_dif(SN_TRABAGRICU), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_TRABAGRICU}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_TRABAGRICU |> 
  dplyr::select(!SN_TRABAGRICU) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_TRABAGRICU}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_TRABAGRICU}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```


### SN_TRABAGRIMUL

```{r data_rules_dist_SN_TRABAGRIMUL}

## df com o resultado das aplicações das regras
df_rules_dist_SN_TRABAGRIMUL <- data |> 
  remove_year_variable(variable = "SN_TRABAGRIMUL", exclusions_years = exclusions_years) |>
  dplyr::filter( # Filtro condicional para variáveis que estão em "ano_base_alter"
    dplyr::case_when(
      "SN_TRABAGRIMUL" %in% names(ano_base_alter) ~ ANO >= ano_base_alter["SN_TRABAGRIMUL"],
      TRUE ~ ANO >= min(ANO, na.rm = T)
    )
  ) |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, SN_TRABAGRIMUL) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_SN_TRABAGRIMUL_hampel_munic  = dplyr::if_else(!hampel_filter(SN_TRABAGRIMUL), F, T), # Longitudinal (município)
    
    DF_SN_TRABAGRIMUL_out_munic     = dplyr::if_else(!outlier_function(SN_TRABAGRIMUL), F, T), # Longitudinal (município)
    
    DF_SN_TRABAGRIMUL_min_munic     = dplyr::if_else(SN_TRABAGRIMUL >= (min(dplyr::lag(SN_TRABAGRIMUL), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_SN_TRABAGRIMUL_max_munic     = dplyr::if_else(SN_TRABAGRIMUL <= (max(dplyr::lag(SN_TRABAGRIMUL), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_TRABAGRIMUL_min_k_munic   = dplyr::if_else(SN_TRABAGRIMUL >= (min(dplyr::lag(SN_TRABAGRIMUL), na.rm = T) / k), F, T), # Longitudinal (município)
     
    DF_SN_TRABAGRIMUL_max_k_munic   = dplyr::if_else(SN_TRABAGRIMUL <= (k * max(dplyr::lag(SN_TRABAGRIMUL), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_SN_TRABAGRIMUL_med_mov_munic = dplyr::if_else(SN_TRABAGRIMUL <= (k * zoo::rollmedian(SN_TRABAGRIMUL, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_SN_TRABAGRIMUL_dif_munic     = dplyr::if_else(!compare_first_dif(SN_TRABAGRIMUL), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_SN_TRABAGRIMUL}

## Transformação dos resultados
df_sumario_dist_sn <- df_rules_dist_SN_TRABAGRIMUL |> 
  dplyr::select(!SN_TRABAGRIMUL) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_sn |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round((Suspeita / (Total - Ausente)) * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_dist_SN_TRABAGRIMUL}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_SN_TRABAGRIMUL}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```




# Análise descritiva

As tabelas a seguir apresentam um resumo descritivo dos indicadores analisados, fornecendo uma visão abrangente das características dos dados. Os cálculos foram realizados em função do ano. As informações inclusas abrangem:

-   **Quantidade de Valores (N):** Indica o número total de observações presentes no conjunto de dados para cada indicador.

-   **Valor Mínimo:** Representa o menor valor observado para o indicador.

-   **Valor da Média:** Indica a média aritmética dos valores do indicador, fornecendo uma medida central da tendência dos dados.

-   **Valor da Mediana:** Representa o valor que divide o conjunto de dados ordenados em duas metades de igual tamanho, sendo útil para lidar com casos com *outliers*.

-   **Valor Máximo:** Indica o maior valor observado para o indicador.

-   **Desvio Padrão (D.P.):** Mede a dispersão dos dados em relação à média, quantificando a variabilidade presente no conjunto.

-   **Coeficiente de Variação (C.V.):** Expressa a razão entre o desvio padrão e a média, em porcentagem, fornecendo uma medida relativa da dispersão dos dados em relação à média.

-   **Quantidade de Zeros:** Indica o número de observações com valor igual a zero para o indicador.

-   **Quantidade de Dados Ausentes:** Representa o número de observações com valores ausentes para o indicador.

**Observações Importantes:**

-   A análise de *outliers* (valores atípicos) não foi realizada nesta tabela descritiva. Para uma avaliação mais completa da qualidade dos dados, recomenda-se a análise de *outliers* e a verificação de possíveis inconsistências nos valores apresentados anteriormente neste documento.

-   A interpretação das medidas descritivas deve ser feita em conjunto com o conhecimento do contexto dos indicadores e dos objetivos da análise.

Ao analisar esta tabela, é possível obter uma compreensão inicial das características dos dados, identificando padrões, tendências e possíveis discrepâncias. As informações aqui apresentadas servem como base para análises estatísticas mais aprofundadas, auxiliando na tomada de decisões e na formulação de conclusões relevantes.

## Tabelas

```{r show_desc_table, results='asis'}
#| column: screen-inset-right

pander::pandoc.header("Descritiva", level = 3)

# Loop para mostrar os resultados por variável
for(var in var_numeric){
  pander::pandoc.header(var, level = 4)
  pander::pandoc.table(
    table_descriptive(variable = var,data = data, ano_base_alter), 
    decimal.mark = ",", 
    big.mark     = ".", 
    round        = 2,
    split.table  = Inf
  )
  cat("\\pagebreak\n")
}
```

## Gráficos

::: {.callout-note appearance="minimal"}
Observação: os gráficos abaixo são mostrados na escala logarítmica para facilitar a visualização dos dados em certos casos. Para conferir os valores reais, consultar as tabelas descritivas.
:::

```{r show_boxplot_chart, results='asis'}
#| out-width: 100%
#| fig-format: svg

pander::pandoc.header("Gráfico de caixa (boxplot)", level = 3)

# Loop para mostrar os resultados por variável
for(var in var_numeric){
  pander::pandoc.header(var, level = 4)
  print(chart_boxplot(variable = var, data = data, ano_base_alter))
  cat("\\pagebreak\n")
}
```

```{r show_hist_chart, results='asis'}
#| out-width: 100%
#| fig-format: svg

pander::pandoc.header("Histograma", level = 3)

# Loop para mostrar os resultados por variável
for(var in var_numeric){
  pander::pandoc.header(var, level = 4)
  print(chart_histogram(variable = var,data = data, ano_base_alter))
  cat("\\pagebreak\n")
}
```

```{r excel_create_wb}

## Criar pasta de trabalho
pt <- openxlsx::createWorkbook()
path_data <- system.file("data", "cidades.xlsx", package = "dataeditfjp")
cidades <- openxlsx::read.xlsx(path_data)

```

```{r df_build_viol_valid}

  variables = c(
    "SN_BAIXO_PESO_NASCER",
    "SN_COR_TOTAL",
    "SN_COR_BAIXOPESO",
    "SN_RECURSO_PAA",
    "SN_MEDIA_RECURSO_AGRICULTOR_PAA",
    "SN_MULHERES_PAA_SOMA",
    "SN_AGRICULTOR_PAA_CADUNICO",
    "SN_DEMANDA_PAA",
    "SN_REPASSE_AGRIC_PNAE",
    "SN_ESCOLAS_PNAE",
    "SN_RAZAO_NUTRI",
    "SN_ESCOLAS_POTAVEL",
    "SN_MEDIA_ARMAZEM",
    "SN_MEDIA_ARMAZEM_NORM",
    "SN_ENERGIA_ESCOLAS",
    "SN_VULNERABILIDADE_ESCOLAS",
    "SN_AGUA_ESCOLAS",
    "SN_ESGOTO_ESCOLAS",
    "SN_LIXO_ESCOLAS",
    "SN_TRABAGRICU",
    "SN_TRABAGRIMUL"
    )

lis <- split(variables,f = variables)
df_obs_valid <- names(lis)|> 
sapply(function(i){
lis[[i]] <- df_rules_valid_sn_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with(i)
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("SN_")),
    names_to  = "regra",
    values_to = "obs_suspeita"
  ) |>
  dplyr::filter(obs_suspeita) |>
  dplyr::rename_with(tolower) |>
  dplyr::left_join(cidades, by = join_by(ibge7==id)) |>
  dplyr::select(-obs_suspeita) |>
  dplyr::arrange(ano, ibge7)
return(lis[[i]])
}, USE.NAMES=TRUE, simplify = FALSE)

index <- sapply(df_obs_valid, nrow)!=0
df_obs_valid <- df_obs_valid[index]

for(i in names(df_obs_valid)){
  j = gsub(pattern = "SN_",replacement = "",x = i)
  openxlsx::addWorksheet(pt, paste0("va-", j))
  openxlsx::writeData(pt, paste0("va-", j), df_obs_valid[[i]])
}

```



```{r df_build_viol_dist}

  df_dist = list(
    "SN_BAIXO_PESO_NASCER"             = df_rules_dist_SN_BAIXO_PESO_NASCER,
    "SN_COR_TOTAL"                     = df_rules_dist_SN_COR_TOTAL,
    "SN_COR_BAIXOPESO"                 = df_rules_dist_SN_COR_BAIXOPESO,
    "SN_RECURSO_PAA"                   = df_rules_dist_SN_RECURSO_PAA,
    "SN_MEDIA_RECURSO_AGRICULTOR_PAA"  = df_rules_dist_SN_MEDIA_RECURSO_AGRICULTOR_PAA,
    "SN_MULHERES_PAA_SOMA"             = df_rules_dist_SN_MULHERES_PAA_SOMA,
    "SN_AGRICULTOR_PAA_CADUNICO"       = df_rules_dist_SN_AGRICULTOR_PAA_CADUNICO,
    "SN_DEMANDA_PAA"                   = df_rules_dist_SN_DEMANDA_PAA,
    "SN_REPASSE_AGRIC_PNAE"            = df_rules_dist_SN_REPASSE_AGRIC_PNAE,
    "SN_ESCOLAS_PNAE"                  = df_rules_dist_SN_ESCOLAS_PNAE,
    "SN_ESCOLAS_POTAVEL"               = df_rules_dist_SN_ESCOLAS_POTAVEL,
    "SN_MEDIA_ARMAZEM"                 = df_rules_dist_SN_MEDIA_ARMAZEM,
    "SN_MEDIA_ARMAZEM_NORM"            = df_rules_dist_SN_MEDIA_ARMAZEM_NORM,
    "SN_ENERGIA_ESCOLAS"               = df_rules_dist_SN_ENERGIA_ESCOLAS,
    "SN_VULNERABILIDADE_ESCOLAS"       = df_rules_dist_SN_VULNERABILIDADE_ESCOLAS,
    "SN_AGUA_ESCOLAS"                  = df_rules_dist_SN_AGUA_ESCOLAS,
    "SN_ESGOTO_ESCOLAS"                = df_rules_dist_SN_ESGOTO_ESCOLAS,
    "SN_LIXO_ESCOLAS"                  = df_rules_dist_SN_LIXO_ESCOLAS,
    "SN_TRABAGRICU"                    = df_rules_dist_SN_TRABAGRICU,
    "SN_TRABAGRIMUL"                   = df_rules_dist_SN_TRABAGRIMUL
  )

df_obs_dist <- names(df_dist)|>
sapply(function(i){
df_dist[[i]] <- df_dist[[i]] |>
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("SN_")),
    names_to  = "regra",
    values_to = "obs_suspeita"
  ) |>
  dplyr::filter(obs_suspeita) |>
  dplyr::rename_with(tolower) |>
  dplyr::left_join(cidades, by = join_by(ibge7==id)) |>
  dplyr::select(-obs_suspeita) |>
  dplyr::arrange(ano, ibge7)
return(df_dist[[i]])
}, USE.NAMES=TRUE, simplify = FALSE)

index <- sapply(df_obs_dist, nrow)!=0
df_obs_dist <- df_obs_dist[index]

for(i in names(df_obs_dist)){
  j = gsub(pattern = "SN_",replacement = "",x = i)
  openxlsx::addWorksheet(pt, paste0("D-", j))
  openxlsx::writeData(pt, paste0("D-", j), df_obs_dist[[i]])
}


```

```{r excel_save_wb}

openxlsx::saveWorkbook(pt, "fjpdados_segurancaalimentar_violacoes.xlsx", overwrite = T)
```

```{r clean_env, results='hide'}

rm(list = ls())
gc()
```
