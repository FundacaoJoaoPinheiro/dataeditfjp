---
title: FJP Dados
subtitle: Economia
description: Relatório contendo uma análise descritiva e os resultados das regras de crítica dos dados da dimensão.
author: 
  name: Coordenação de Indicadores Sociais (CIS)
  affiliation: 
    name: Diretoria de Estatística e Informações (Direi)
    address: Alameda das Acácias, 70 - São Luiz 
    city: Belo Horizonte
    state: Minas Gerais
    postal-code: 31.275-150
    url: https://fjp.mg.gov.br/
lang: pt
date: today
title-block-banner: "#00b4d8"
title-block-banner-color: "#ffffff"
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    toc: true
    toc-location: left
    toc-title: MENU
    linkcolor: "#00b4d8"
    css: css/all_custom.css
    theme:
      light: [flatly, css/ea_custom.scss]
editor: visual
execute:
  echo: false
  warning: false
  error: false
  message: false
params:
  data: file.xlsx
output-file: "ea_relatorio.html"
---

```{r source_functions}

# source(sistem.file("R", "aux_functions.R"), package = "criticaldatafjp")
source(here::here("R", "aux_functions.R"))
```

```{r set_param_global}

k <- 1.5 

## "Truque" para setar "k" como uma constante
lockBinding("k", globalenv())
```

```{r import_data}

data <- openxlsx::read.xlsx(params$data)
```

```{r get_var_numeric}

# Obter as siglas das variáveis do tipo numérico
var_numeric <- data |> 
  dplyr::select(
    !c("CHAVE", "IBGE6", "IBGE7", "ANO") & dplyr::where(is.numeric)
  ) |> 
  colnames() |> 
  unlist()
```

```{r get_var_character}

# Obter as siglas variáveis do tipo string
var_char <- data |> 
  dplyr::select(
    !c("CHAVE", "IBGE6", "IBGE7", "ANO") & dplyr::where(is.character)
  ) |> 
  colnames() |> 
  unlist()
```

# Introdução

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi sollicitudin, metus nec rhoncus posuere, leo dolor auctor neque, ut consectetur massa sem et nibh. Vivamus aliquam arcu sed ligula tincidunt, vel iaculis felis accumsan. Fusce in pellentesque erat. In vel euismod justo. Suspendisse imperdiet nulla eget dolor ornare, in viverra massa congue. Suspendisse nec vestibulum lectus. Phasellus venenatis vel turpis ut finibus. Vivamus vehicula neque sem, at ullamcorper magna finibus at. Praesent pulvinar, enim id pellentesque ultricies, magna nibh suscipit magna, at viverra dolor neque vel dolor. Quisque vestibulum orci et ex pharetra, vitae feugiat nulla sollicitudin. Suspendisse posuere aliquet.

# Regras de crítica

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi sollicitudin, metus nec rhoncus posuere, leo dolor auctor neque, ut consectetur massa sem et nibh. Vivamus aliquam arcu sed ligula tincidunt, vel iaculis felis accumsan. Fusce in pellentesque erat. In vel euismod justo. Suspendisse imperdiet nulla eget dolor ornare, in viverra massa congue. Suspendisse nec vestibulum lectus. Phasellus venenatis vel turpis ut finibus. Vivamus vehicula neque sem, at ullamcorper magna finibus at. Praesent pulvinar, enim id pellentesque ultricies, magna nibh suscipit magna, at viverra dolor neque vel dolor. Quisque vestibulum orci et ex pharetra, vitae feugiat nulla sollicitudin. Suspendisse posuere aliquet.

-   Tipo

    -   **TI\_\[...\]**: tipo do dado está de acordo com o esperado (numérico, textual ou categórico).

-   Validade

    -   **VI_NA\_\[...\]**: dado não tem valor ausente/*missing*;
    -   **VI\_\[...\]**: dado é não negativo, está devidamente categorizado ou está entre o intervalo esperado (ex.: 0% e 100%).

-   Consistência

    -   **CF\_\[...\]\_total_munic**: a soma da proporção municipal é igual a $\approx$ 100%.

-   Distribuição

    -   **DF\_\[...\]\_hampel_munic**: método de identificação de um possível valor *outlier* na série histórica;

    -   **DF\_\[...\]\_out_munic**: segundo método de identificação de um possível valor *outlier* na série histórica;

    -   **DF\_\[...\]\_min_munic**: o valor mais recente é maior ou igual ao menor valor da série histórica;

    -   **DF\_\[...\]\_max_munic**: o valor mais recente é menor ou igual ao maior valor da série histórica;

    -   **DF\_\[...\]\_min_k_munic**: o valor mais recente é maior ou igual ao $\frac{menor}{k}$ valor da série histórica;

    -   **DF\_\[...\]\_max_k_munic**: o valor mais recente é menor ou igual ao $maior \times k$ valor da série histórica;

    -   **DF\_\[...\]\_med_mov_munic:** o valor atual é menor ou igual a $\text{mediana móvel} \times k$;

    -   **DF\_\[...\]\_dif_munic**: o valor mais recente da primeira diferença é menor ou igual ao maior valor da primeira diferença da série histórica;

    -   **DF\_\[...\]\_estoque_munic**: valor atual é maior ou igual ao valor imediatamente anterior.

```{r map_valid_desc}

# Mapear variável e descrição de sua respectiva regra de validade para ser apresentado na tabela.
desc_regra_valid <- c(
  # Casos mais comuns
  `1` = "Valor é ≥ 0",
  `2` = "Valor está dentro da categoria esperada",
  `3` = "Valor está dentro da faixa esperada (0 a 100)",
  `4` = "Valor está dentro da faixa esperada (0 a 1000)",
  `5` = "Valor está dentro da faixa esperada (0 a 10000)",
  `6` = "Valor está dentro da faixa esperada (0 a 100000)",
  # Casos especiais
  `7` = "Valor é ≥ 1", # SP_PM e SP_PMPC
  `8` = "Valor é ≥ 8" # SP_PM1
)

# df com o nome da regra e a respectiva descrição
desc_regra_valid_var <- data.frame(
  Regra = c(
    "VI_EA_BFFAM",    
    "VI_EA_TRFAM",    
    "VI_EA_TRPF",     
    "VI_EA_BPCDEF",   
    "VI_EA_BPCIDO",   
    "VI_EA_BFBPC",    
    "VI_EA_TRBPCDEF",
    "VI_EA_TRBPCIDO", 
    "VI_EA_TRBPC",    
    "VI_EA_TRBPCPB",  
    "VI_EA_TRBFBPC",  
    "VI_EA_TRPC",     
    "VI_EA_TRPCBF",   
    "VI_EA_TRPCBPC",  
    "VI_EA_VAAGR",    
    "VI_EA_VAIND",    
    "VI_EA_VAADM",    
    "VI_EA_VASERV",   
    "VI_EA_PVAAGR",  
    "VI_EA_PVAIND",   
    "VI_EA_PVAADM",   
    "VI_EA_PVASERV", 
    "VI_EA_VATOT",   
    "VI_EA_IMPLIQ",   
    "VI_EA_PIB",      
    "VI_EA_PIBPC",    
    "VI_EA_VAFAG",    
    "VI_EA_VAF",      
    "VI_EA_VAFMI",    
    "VI_EA_VAFIT",    
    "VI_EA_VAFIC",    
    "VI_EA_VAFUP",    
    "VI_EA_VAFCV",    
    "VI_EA_VAFCA",    
    "VI_EA_VAFSE",    
    "VI_EA_VAFO",     
    "VI_EA_PVAFAG",   
    "VI_EA_PVAFMI",   
    "VI_EA_PVAFIT",   
    "VI_EA_PVAFIC",   
    "VI_EA_PVAFUP",   
    "VI_EA_PVAFCV",   
    "VI_EA_PVAFCA",   
    "VI_EA_PVAFSE",   
    "VI_EA_PVAFO",   
    "VI_EA_VAFPC",    
    "VI_EA_VAFCVPC",  
    "VI_EA_EMPRSF",   
    "VI_EA_EMPRSFTX", 
    "VI_EA_RENSF",    
    "VI_EA_RENPCSF",  
    "VI_EA_EMPRSFAG", 
    "VI_EA_EMPRSFMI", 
    "VI_EA_EMPRSFIT", 
    "VI_EA_EMPRSFUP", 
    "VI_EA_EMPRSFIC", 
    "VI_EA_EMPRSFCO", 
    "VI_EA_EMPRSFSE"
  )
) |> 
  dplyr::mutate(
    `Descrição` = dplyr::case_match(
      Regra,
      "VI_EA_BFFAM"    ~ desc_regra_valid[1],
      "VI_EA_TRFAM"    ~ desc_regra_valid[1],
      "VI_EA_TRPF"     ~ desc_regra_valid[1],
      "VI_EA_BPCDEF"   ~ desc_regra_valid[1],
      "VI_EA_BPCIDO"   ~ desc_regra_valid[1],
      "VI_EA_BFBPC"    ~ desc_regra_valid[1],
      "VI_EA_TRBPCDEF" ~ desc_regra_valid[1],
      "VI_EA_TRBPCIDO" ~ desc_regra_valid[1],
      "VI_EA_TRBPC"    ~ desc_regra_valid[1],
      "VI_EA_TRBPCPB"  ~ desc_regra_valid[1],
      "VI_EA_TRBFBPC"  ~ desc_regra_valid[1],
      "VI_EA_TRPC"     ~ desc_regra_valid[1],
      "VI_EA_TRPCBF"   ~ desc_regra_valid[1],
      "VI_EA_TRPCBPC"  ~ desc_regra_valid[1],
      "VI_EA_VAAGR"    ~ desc_regra_valid[1],
      "VI_EA_VAIND"    ~ desc_regra_valid[1],
      "VI_EA_VAADM"    ~ desc_regra_valid[1],
      "VI_EA_VASERV"   ~ desc_regra_valid[1],
      "VI_EA_PVAAGR"   ~ desc_regra_valid[3],
      "VI_EA_PVAIND"   ~ desc_regra_valid[3],
      "VI_EA_PVAADM"   ~ desc_regra_valid[3],
      "VI_EA_PVASERV"  ~ desc_regra_valid[3],
      "VI_EA_VATOT"    ~ desc_regra_valid[1],
      "VI_EA_IMPLIQ"   ~ desc_regra_valid[1],
      "VI_EA_PIB"      ~ desc_regra_valid[1],
      "VI_EA_PIBPC"    ~ desc_regra_valid[1],
      "VI_EA_VAFAG"    ~ desc_regra_valid[1],
      "VI_EA_VAF"      ~ desc_regra_valid[1],
      "VI_EA_VAFMI"    ~ desc_regra_valid[1],
      "VI_EA_VAFIT"    ~ desc_regra_valid[1],
      "VI_EA_VAFIC"    ~ desc_regra_valid[1],
      "VI_EA_VAFUP"    ~ desc_regra_valid[1],
      "VI_EA_VAFCV"    ~ desc_regra_valid[1],
      "VI_EA_VAFCA"    ~ desc_regra_valid[1],
      "VI_EA_VAFSE"    ~ desc_regra_valid[1],
      "VI_EA_VAFO"     ~ desc_regra_valid[1],
      "VI_EA_PVAFAG"   ~ desc_regra_valid[3],
      "VI_EA_PVAFMI"   ~ desc_regra_valid[3],
      "VI_EA_PVAFIT"   ~ desc_regra_valid[3],
      "VI_EA_PVAFIC"   ~ desc_regra_valid[3],
      "VI_EA_PVAFUP"   ~ desc_regra_valid[3],
      "VI_EA_PVAFCV"   ~ desc_regra_valid[3],
      "VI_EA_PVAFCA"   ~ desc_regra_valid[3],
      "VI_EA_PVAFSE"   ~ desc_regra_valid[3],
      "VI_EA_PVAFO"    ~ desc_regra_valid[3],
      "VI_EA_VAFPC"    ~ desc_regra_valid[1],
      "VI_EA_VAFCVPC"  ~ desc_regra_valid[1],
      "VI_EA_EMPRSF"   ~ desc_regra_valid[1],
      "VI_EA_EMPRSFTX" ~ desc_regra_valid[3],
      "VI_EA_RENSF"    ~ desc_regra_valid[1],
      "VI_EA_RENPCSF"  ~ desc_regra_valid[1],
      "VI_EA_EMPRSFAG" ~ desc_regra_valid[1],
      "VI_EA_EMPRSFMI" ~ desc_regra_valid[1],
      "VI_EA_EMPRSFIT" ~ desc_regra_valid[1],
      "VI_EA_EMPRSFUP" ~ desc_regra_valid[1],
      "VI_EA_EMPRSFIC" ~ desc_regra_valid[1],
      "VI_EA_EMPRSFCO" ~ desc_regra_valid[1],
      "VI_EA_EMPRSFSE" ~ desc_regra_valid[1]
    )
  )
```

```{r map_consist_desc}

# Mapear variável e descrição de sua respectiva regra de consistência para ser apresentado na tabela.
desc_regra_consist <- c(
  `1` = "A soma da proporção anual é igual a 100%", # MA_FOCOS
  `2` = "A soma de EA_BPCDEF e EA_BPCIDO é igual a EA_BFBPC",
  `3` = "A soma de EA_TRBPCDEF e EA_TRBPCIDO é igual a EA_TRBPC",
  `4` = "A soma de EA_PVAAGR, EA_PVAIND, EA_PVAADM e EA_PVASERV é igual a 100%",
  `5` = "A soma de EA_PVAFAG, EA_PVAFMI, EA_PVAFIT, EA_PVAFIC, EA_PVAFUP, EA_PVAFCV, EA_PVAFCA, EA_PVAFSE e EA_PVAFO é igual a 100%"
)

# df com o nome da regra e a respectiva descrição
desc_regra_consist_var <- data.frame(
  Regra = c(
    "CI_BPC_total_munic",
    "CI_TRBPC_total_munic",
    "CI_VAF_total_munic",
    "CI_VA_total_munic"
  )
) |> 
  dplyr::mutate(
    `Descrição` = dplyr::case_match(
      Regra,
      "CI_BPC_total_munic"   ~ desc_regra_consist[2],
      "CI_TRBPC_total_munic" ~ desc_regra_consist[3],
      "CI_VAF_total_munic"   ~ desc_regra_consist[4],
      "CI_VA_total_munic"    ~ desc_regra_consist[5]
    )
  )
```

## Tipo

### Todos os indicadores

```{r rules_type}
  
rules_type <- validate::validator(
  TI_EA_BFFAM    = is.numeric(EA_BFFAM),
  TI_EA_TRFAM    = is.numeric(EA_TRFAM),
  TI_EA_TRPF     = is.numeric(EA_TRPF),
  TI_EA_BPCDEF   = is.numeric(EA_BPCDEF),
  TI_EA_BPCIDO   = is.numeric(EA_BPCIDO),
  TI_EA_BFBPC    = is.numeric(EA_BFBPC),
  TI_EA_TRBPCDEF = is.numeric(EA_TRBPCDEF),
  TI_EA_TRBPCIDO = is.numeric(EA_TRBPCIDO),
  TI_EA_TRBPC    = is.numeric(EA_TRBPC),
  TI_EA_TRBPCPB  = is.numeric(EA_TRBPCPB),
  TI_EA_TRBFBPC  = is.numeric(EA_TRBFBPC),
  TI_EA_TRPC     = is.numeric(EA_TRPC),
  TI_EA_TRPCBF   = is.numeric(EA_TRPCBF),
  TI_EA_TRPCBPC  = is.numeric(EA_TRPCBPC),
  TI_EA_VAAGR    = is.numeric(EA_VAAGR),
  TI_EA_VAIND    = is.numeric(EA_VAIND),
  TI_EA_VAADM    = is.numeric(EA_VAADM),
  TI_EA_VASERV   = is.numeric(EA_VASERV),
  TI_EA_PVAAGR   = is.numeric(EA_PVAAGR),
  TI_EA_PVAIND   = is.numeric(EA_PVAIND),
  TI_EA_PVAADM   = is.numeric(EA_PVAADM),
  TI_EA_PVASERV  = is.numeric(EA_PVASERV),
  TI_EA_VATOT    = is.numeric(EA_VATOT),
  TI_EA_IMPLIQ   = is.numeric(EA_IMPLIQ),
  TI_EA_PIB      = is.numeric(EA_PIB),
  TI_EA_PIBPC    = is.numeric(EA_PIBPC),
  TI_EA_VAFAG    = is.numeric(EA_VAFAG),
  TI_EA_VAF      = is.numeric(EA_VAF),
  TI_EA_VAFMI    = is.numeric(EA_VAFMI),
  TI_EA_VAFIT    = is.numeric(EA_VAFIT),
  TI_EA_VAFIC    = is.numeric(EA_VAFIC),
  TI_EA_VAFUP    = is.numeric(EA_VAFUP),
  TI_EA_VAFCV    = is.numeric(EA_VAFCV),
  TI_EA_VAFCA    = is.numeric(EA_VAFCA),
  TI_EA_VAFSE    = is.numeric(EA_VAFSE),
  TI_EA_VAFO     = is.numeric(EA_VAFO),
  TI_EA_PVAFAG   = is.numeric(EA_PVAFAG),
  TI_EA_PVAFMI   = is.numeric(EA_PVAFMI),
  TI_EA_PVAFIT   = is.numeric(EA_PVAFIT),
  TI_EA_PVAFIC   = is.numeric(EA_PVAFIC),
  TI_EA_PVAFUP   = is.numeric(EA_PVAFUP),
  TI_EA_PVAFCV   = is.numeric(EA_PVAFCV),
  TI_EA_PVAFCA   = is.numeric(EA_PVAFCA),
  TI_EA_PVAFSE   = is.numeric(EA_PVAFSE),
  TI_EA_PVAFO    = is.numeric(EA_PVAFO),
  TI_EA_VAFPC    = is.numeric(EA_VAFPC),
  TI_EA_VAFCVPC  = is.numeric(EA_VAFCVPC),
  TI_EA_EMPRSF   = is.numeric(EA_EMPRSF),
  TI_EA_EMPRSFTX = is.numeric(EA_EMPRSFTX),
  TI_EA_RENSF    = is.numeric(EA_RENSF),
  TI_EA_RENPCSF  = is.numeric(EA_RENPCSF),
  TI_EA_EMPRSFAG = is.numeric(EA_EMPRSFAG),
  TI_EA_EMPRSFMI = is.numeric(EA_EMPRSFMI),
  TI_EA_EMPRSFIT = is.numeric(EA_EMPRSFIT),
  TI_EA_EMPRSFUP = is.numeric(EA_EMPRSFUP),
  TI_EA_EMPRSFIC = is.numeric(EA_EMPRSFIC),
  TI_EA_EMPRSFCO = is.numeric(EA_EMPRSFCO),
  TI_EA_EMPRSFSE = is.numeric(EA_EMPRSFSE)
)
```

```{r confront_type}

## Confrontar os dados com as regras e exibir uma tabela com os resultados
check_type <- validate::confront(data, rules_type)

validate::summary(check_type) |> 
  dplyr::select(
    Regra    = name,
    Validada = passes
  ) |> 
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |>
  kableExtra::kable_paper("hover", full_width = F)
```

## Validade

```{r data_rules_valid_ea_all}

df_rules_valid_ea_all <- data |> 
  dplyr::select(
    Ano   = ANO, 
    ibge7 = IBGE7, 
    dplyr::starts_with("EA_")
  ) |> 
  dplyr::mutate(
    # Missing
    VI_NA_EA_BFFAM    = dplyr::if_else(!is.na(EA_BFFAM), F, NA),
    VI_NA_EA_TRFAM    = dplyr::if_else(!is.na(EA_TRFAM), F, NA),
    VI_NA_EA_TRPF     = dplyr::if_else(!is.na(EA_TRPF), F, NA),
    VI_NA_EA_BPCDEF   = dplyr::if_else(!is.na(EA_BPCDEF), F, NA),
    VI_NA_EA_BPCIDO   = dplyr::if_else(!is.na(EA_BPCIDO), F, NA),
    VI_NA_EA_BFBPC    = dplyr::if_else(!is.na(EA_BFBPC), F, NA),
    VI_NA_EA_TRBPCDEF = dplyr::if_else(!is.na(EA_TRBPCDEF), F, NA),
    VI_NA_EA_TRBPCIDO = dplyr::if_else(!is.na(EA_TRBPCIDO), F, NA),
    VI_NA_EA_TRBPC    = dplyr::if_else(!is.na(EA_TRBPC), F, NA),
    VI_NA_EA_TRBPCPB  = dplyr::if_else(!is.na(EA_TRBPCPB), F, NA),
    VI_NA_EA_TRBFBPC  = dplyr::if_else(!is.na(EA_TRBFBPC), F, NA),
    VI_NA_EA_TRPC     = dplyr::if_else(!is.na(EA_TRPC), F, NA),
    VI_NA_EA_TRPCBF   = dplyr::if_else(!is.na(EA_TRPCBF), F, NA),
    VI_NA_EA_TRPCBPC  = dplyr::if_else(!is.na(EA_TRPCBPC), F, NA),
    VI_NA_EA_VAAGR    = dplyr::if_else(!is.na(EA_VAAGR), F, NA),
    VI_NA_EA_VAIND    = dplyr::if_else(!is.na(EA_VAIND), F, NA),
    VI_NA_EA_VAADM    = dplyr::if_else(!is.na(EA_VAADM), F, NA),
    VI_NA_EA_VASERV   = dplyr::if_else(!is.na(EA_VASERV), F, NA),
    VI_NA_EA_PVAAGR   = dplyr::if_else(!is.na(EA_PVAAGR), F, NA),
    VI_NA_EA_PVAIND   = dplyr::if_else(!is.na(EA_PVAIND), F, NA),
    VI_NA_EA_PVAADM   = dplyr::if_else(!is.na(EA_PVAADM), F, NA),
    VI_NA_EA_PVASERV  = dplyr::if_else(!is.na(EA_PVASERV), F, NA),
    VI_NA_EA_VATOT    = dplyr::if_else(!is.na(EA_VATOT), F, NA),
    VI_NA_EA_IMPLIQ   = dplyr::if_else(!is.na(EA_IMPLIQ), F, NA),
    VI_NA_EA_PIB      = dplyr::if_else(!is.na(EA_PIB), F, NA),
    VI_NA_EA_PIBPC    = dplyr::if_else(!is.na(EA_PIBPC), F, NA),
    VI_NA_EA_VAFAG    = dplyr::if_else(!is.na(EA_VAFAG), F, NA),
    VI_NA_EA_VAF      = dplyr::if_else(!is.na(EA_VAF), F, NA),
    VI_NA_EA_VAFMI    = dplyr::if_else(!is.na(EA_VAFMI), F, NA),
    VI_NA_EA_VAFIT    = dplyr::if_else(!is.na(EA_VAFIT), F, NA),
    VI_NA_EA_VAFIC    = dplyr::if_else(!is.na(EA_VAFIC), F, NA),
    VI_NA_EA_VAFUP    = dplyr::if_else(!is.na(EA_VAFUP), F, NA),
    VI_NA_EA_VAFCV    = dplyr::if_else(!is.na(EA_VAFCV), F, NA),
    VI_NA_EA_VAFCA    = dplyr::if_else(!is.na(EA_VAFCA), F, NA),
    VI_NA_EA_VAFSE    = dplyr::if_else(!is.na(EA_VAFSE), F, NA),
    VI_NA_EA_VAFO     = dplyr::if_else(!is.na(EA_VAFO), F, NA),
    VI_NA_EA_PVAFAG   = dplyr::if_else(!is.na(EA_PVAFAG), F, NA),
    VI_NA_EA_PVAFMI   = dplyr::if_else(!is.na(EA_PVAFMI), F, NA),
    VI_NA_EA_PVAFIT   = dplyr::if_else(!is.na(EA_PVAFIT), F, NA),
    VI_NA_EA_PVAFIC   = dplyr::if_else(!is.na(EA_PVAFIC), F, NA),
    VI_NA_EA_PVAFUP   = dplyr::if_else(!is.na(EA_PVAFUP), F, NA),
    VI_NA_EA_PVAFCV   = dplyr::if_else(!is.na(EA_PVAFCV), F, NA),
    VI_NA_EA_PVAFCA   = dplyr::if_else(!is.na(EA_PVAFCA), F, NA),
    VI_NA_EA_PVAFSE   = dplyr::if_else(!is.na(EA_PVAFSE), F, NA),
    VI_NA_EA_PVAFO    = dplyr::if_else(!is.na(EA_PVAFO), F, NA),
    VI_NA_EA_VAFPC    = dplyr::if_else(!is.na(EA_VAFPC), F, NA),
    VI_NA_EA_VAFCVPC  = dplyr::if_else(!is.na(EA_VAFCVPC), F, NA),
    VI_NA_EA_EMPRSF   = dplyr::if_else(!is.na(EA_EMPRSF), F, NA),
    VI_NA_EA_EMPRSFTX = dplyr::if_else(!is.na(EA_EMPRSFTX), F, NA),
    VI_NA_EA_RENSF    = dplyr::if_else(!is.na(EA_RENSF), F, NA),
    VI_NA_EA_RENPCSF  = dplyr::if_else(!is.na(EA_RENPCSF), F, NA),
    VI_NA_EA_EMPRSFAG = dplyr::if_else(!is.na(EA_EMPRSFAG), F, NA),
    VI_NA_EA_EMPRSFMI = dplyr::if_else(!is.na(EA_EMPRSFMI), F, NA),
    VI_NA_EA_EMPRSFIT = dplyr::if_else(!is.na(EA_EMPRSFIT), F, NA),
    VI_NA_EA_EMPRSFUP = dplyr::if_else(!is.na(EA_EMPRSFUP), F, NA),
    VI_NA_EA_EMPRSFIC = dplyr::if_else(!is.na(EA_EMPRSFIC), F, NA),
    VI_NA_EA_EMPRSFCO = dplyr::if_else(!is.na(EA_EMPRSFCO), F, NA),
    VI_NA_EA_EMPRSFSE = dplyr::if_else(!is.na(EA_EMPRSFSE), F, NA),
    # Others
    VI_EA_BFFAM    = dplyr::if_else(EA_BFFAM >= 0, F, T),
    VI_EA_TRFAM    = dplyr::if_else(EA_TRFAM >= 0, F, T),
    VI_EA_TRPF     = dplyr::if_else(EA_TRPF >= 0, F, T),
    VI_EA_BPCDEF   = dplyr::if_else(EA_BPCDEF >= 0, F, T),
    VI_EA_BPCIDO   = dplyr::if_else(EA_BPCIDO >= 0, F, T),
    VI_EA_BFBPC    = dplyr::if_else(EA_BFBPC >= 0, F, T),
    VI_EA_TRBPCDEF = dplyr::if_else(EA_TRBPCDEF >= 0, F, T),
    VI_EA_TRBPCIDO = dplyr::if_else(EA_TRBPCIDO >= 0, F, T),
    VI_EA_TRBPC    = dplyr::if_else(EA_TRBPC >= 0, F, T),
    VI_EA_TRBPCPB  = dplyr::if_else(EA_TRBPCPB >= 0, F, T),
    VI_EA_TRBFBPC  = dplyr::if_else(EA_TRBFBPC >= 0, F, T),
    VI_EA_TRPC     = dplyr::if_else(EA_TRPC >= 0, F, T),
    VI_EA_TRPCBF   = dplyr::if_else(EA_TRPCBF >= 0, F, T),
    VI_EA_TRPCBPC  = dplyr::if_else(EA_TRPCBPC >= 0, F, T),
    VI_EA_VAAGR    = dplyr::if_else(EA_VAAGR >= 0, F, T),
    VI_EA_VAIND    = dplyr::if_else(EA_VAIND >= 0, F, T),
    VI_EA_VAADM    = dplyr::if_else(EA_VAADM >= 0, F, T),
    VI_EA_VASERV   = dplyr::if_else(EA_VASERV >= 0, F, T),
    
    VI_EA_PVAAGR   = dplyr::if_else(dplyr::between(EA_PVAAGR, 0, 100), F, T),
    
    VI_EA_PVAIND   = dplyr::if_else(dplyr::between(EA_PVAIND, 0, 100), F, T),
    
    VI_EA_PVAADM   = dplyr::if_else(dplyr::between(EA_PVAADM, 0, 100), F, T),
    
    VI_EA_PVASERV  = dplyr::if_else(dplyr::between(EA_PVASERV, 0, 100), F, T),
    
    VI_EA_VATOT    = dplyr::if_else(EA_VATOT >= 0, F, T),
    VI_EA_IMPLIQ   = dplyr::if_else(EA_IMPLIQ >= 0, F, T),
    VI_EA_PIB      = dplyr::if_else(EA_PIB >= 0, F, T),
    VI_EA_PIBPC    = dplyr::if_else(EA_PIBPC >= 0, F, T),
    VI_EA_VAFAG    = dplyr::if_else(EA_VAFAG >= 0, F, T),
    VI_EA_VAF      = dplyr::if_else(EA_VAF >= 0, F, T),
    VI_EA_VAFMI    = dplyr::if_else(EA_VAFMI >= 0, F, T),
    VI_EA_VAFIT    = dplyr::if_else(EA_VAFIT >= 0, F, T),
    VI_EA_VAFIC    = dplyr::if_else(EA_VAFIC >= 0, F, T),
    VI_EA_VAFUP    = dplyr::if_else(EA_VAFUP >= 0, F, T),
    VI_EA_VAFCV    = dplyr::if_else(EA_VAFCV >= 0, F, T),
    VI_EA_VAFCA    = dplyr::if_else(EA_VAFCA >= 0, F, T),
    VI_EA_VAFSE    = dplyr::if_else(EA_VAFSE >= 0, F, T),
    VI_EA_VAFO     = dplyr::if_else(EA_VAFO >= 0, F, T),
    
    VI_EA_PVAFAG   = dplyr::if_else(dplyr::between(EA_PVAFAG, 0, 100), F, T),
    
    VI_EA_PVAFMI   = dplyr::if_else(dplyr::between(EA_PVAFMI, 0, 100), F, T),
    
    VI_EA_PVAFIT   = dplyr::if_else(dplyr::between(EA_PVAFIT, 0, 100), F, T),
    
    VI_EA_PVAFIC   = dplyr::if_else(dplyr::between(EA_PVAFIC, 0, 100), F, T),
    
    VI_EA_PVAFUP   = dplyr::if_else(dplyr::between(EA_PVAFUP, 0, 100), F, T),
    
    VI_EA_PVAFCV   = dplyr::if_else(dplyr::between(EA_PVAFCV, 0, 100), F, T),
    
    VI_EA_PVAFCA   = dplyr::if_else(dplyr::between(EA_PVAFCA, 0, 100), F, T),
    
    VI_EA_PVAFSE   = dplyr::if_else(dplyr::between(EA_PVAFSE, 0, 100), F, T),
    
    VI_EA_PVAFO    = dplyr::if_else(dplyr::between(EA_PVAFO, 0, 100), F, T),
    
    VI_EA_VAFPC    = dplyr::if_else(EA_VAFPC >= 0, F, T),
    VI_EA_VAFCVPC  = dplyr::if_else(EA_VAFCVPC >= 0, F, T),
    VI_EA_EMPRSF   = dplyr::if_else(EA_EMPRSF >= 0, F, T),
    
    VI_EA_EMPRSFTX = dplyr::if_else(dplyr::between(EA_EMPRSFTX, 0, 100), F, T),
    
    VI_EA_RENSF    = dplyr::if_else(EA_RENSF >= 0, F, T),
    VI_EA_RENPCSF  = dplyr::if_else(EA_RENPCSF >= 0, F, T),
    VI_EA_EMPRSFAG = dplyr::if_else(EA_EMPRSFAG >= 0, F, T),
    VI_EA_EMPRSFMI = dplyr::if_else(EA_EMPRSFMI >= 0, F, T),
    VI_EA_EMPRSFIT = dplyr::if_else(EA_EMPRSFIT >= 0, F, T),
    VI_EA_EMPRSFUP = dplyr::if_else(EA_EMPRSFUP >= 0, F, T),
    VI_EA_EMPRSFIC = dplyr::if_else(EA_EMPRSFIC >= 0, F, T),
    VI_EA_EMPRSFCO = dplyr::if_else(EA_EMPRSFCO >= 0, F, T),
    VI_EA_EMPRSFSE = dplyr::if_else(EA_EMPRSFSE >= 0, F, T)
)
```

```{r data_wrangling_valid_ea_all}

## Transformação dos resultados
df_sumario_valid_ea <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano, 
    ibge7, 
    dplyr::starts_with(c("VI_", "VF_"))
  ) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_valid_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

### Todos os indicadores - Valores ausentes

```{r table_valid_ea_na_all}

df_sumario |>
  dplyr::select(Ano, Regra, Total, contains("Ausente")) |>
  dplyr::filter(
    Ano == max(Ano) & 
    stringr::str_detect(Regra, "_NA_")
  ) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

### Todos os indicadores - Demais regras

```{r table_valid_ea_all}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(
    Ano == max(Ano) & 
    stringr::str_detect(Regra, "_NA_", negate = T)
  ) |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  dplyr::left_join(desc_regra_valid_var, by = dplyr::join_by(Regra)) |> # Introdução coluna descrição
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

## Consistência

```{r data_rules_consist_ea_all}

## df com o resultado das aplicações das regras
df_rules_consist_ea_all <- data |> 
  dplyr::select(
    Ano   = ANO, 
    ibge7 = IBGE7,
    EA_BPCDEF:EA_BFBPC,
    EA_TRBPCDEF:EA_TRBPC,
    EA_PVAAGR:EA_PVASERV,
    EA_PVAFAG:EA_PVAFO
  ) |> 
  dplyr::mutate(
    CI_BPC_total_munic   = dplyr::if_else(rowSums(dplyr::across(c(EA_BPCDEF, EA_BPCIDO)), na.rm = T) <= (EA_BFBPC + .005), F, T),
    CI_TRBPC_total_munic = dplyr::if_else(rowSums(dplyr::across(c(EA_TRBPCDEF, EA_TRBPCIDO)), na.rm = T) <= (EA_TRBPC + .005), F, T),
    CI_VA_total_munic    = dplyr::if_else(dplyr::between(EA_PVAAGR + EA_PVAIND + EA_PVAADM + EA_PVASERV, 99.5, 100.5), F, T),
    CI_VAF_total_munic   = dplyr::if_else(dplyr::between(EA_PVAFAG + EA_PVAFMI + EA_PVAFIT + EA_PVAFIC + EA_PVAFUP + EA_PVAFCV + EA_PVAFCA + EA_PVAFSE + EA_PVAFO, 99.5, 100.5), F, T)
)
```

```{r data_wrangling_consist_ea_all}

## Tranformação dos resultados
df_sumario_consist_ea <- df_rules_consist_ea_all |> 
  dplyr::select(
    !c(
        EA_BPCDEF:EA_BFBPC, 
        EA_TRBPCDEF:EA_TRBPC, 
        EA_PVAAGR:EA_PVASERV, 
        EA_PVAFAG:EA_PVAFO
      )
  ) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_consist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

### Todos os indicadores

```{r table_consist_ea_all}
#| column: screen-inset-right

df_sumario |> 
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  dplyr::left_join(desc_regra_consist_var, by = dplyr::join_by(Regra)) |> # Introdução coluna descrição
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

## Distribuição

### EA_BFFAM

```{r rules_dist_ea_bffam}

df_rules_dist_ea_bffam <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_BFFAM) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_BFFAM_hampel_munic  = dplyr::if_else(!hampel_filter(EA_BFFAM), F, T), # Longitudinal (município)
    
    DF_EA_BFFAM_out_munic     = dplyr::if_else(!outlier_detection(EA_BFFAM), F, T), # Longitudinal (município)
    
    DF_EA_BFFAM_min_munic     = dplyr::if_else(EA_BFFAM >= (min(dplyr::lag(EA_BFFAM), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_EA_BFFAM_max_munic     = dplyr::if_else(EA_BFFAM <= (max(dplyr::lag(EA_BFFAM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BFFAM_min_k_munic   = dplyr::if_else(EA_BFFAM >= (min(dplyr::lag(EA_BFFAM), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_BFFAM_max_k_munic   = dplyr::if_else(EA_BFFAM <= (k * max(dplyr::lag(EA_BFFAM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BFFAM_med_mov_munic = dplyr::if_else(EA_BFFAM <= (k * zoo::rollmedian(EA_BFFAM, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_BFFAM_dif_munic     = dplyr::if_else(!compare_first_dif(EA_BFFAM), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_ea_bffam}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_bffam |> 
  dplyr::select(!EA_BFFAM) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_bffam}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_bffam}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_TRFAM

```{r rules_dist_ea_trfam}

df_rules_dist_ea_trfam <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_TRFAM) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_TRFAM_hampel_munic  = dplyr::if_else(!hampel_filter(EA_TRFAM), F, T), # Longitudinal (município)
    
    DF_EA_TRFAM_out_munic     = dplyr::if_else(!outlier_detection(EA_TRFAM), F, T), # Longitudinal (município)
    
    DF_EA_TRFAM_min_munic     = dplyr::if_else(EA_TRFAM >= (min(dplyr::lag(EA_TRFAM), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_EA_TRFAM_max_munic     = dplyr::if_else(EA_TRFAM <= (max(dplyr::lag(EA_TRFAM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRFAM_min_k_munic   = dplyr::if_else(EA_TRFAM >= (min(dplyr::lag(EA_TRFAM), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_TRFAM_max_k_munic   = dplyr::if_else(EA_TRFAM <= (k * max(dplyr::lag(EA_TRFAM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRFAM_med_mov_munic = dplyr::if_else(EA_TRFAM <= (k * zoo::rollmedian(EA_TRFAM, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_TRFAM_dif_munic     = dplyr::if_else(!compare_first_dif(EA_TRFAM), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_ea_trfam}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_trfam |> 
  dplyr::select(!EA_TRFAM) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_trfam}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_trfam}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_TRPF

```{r rules_dist_ea_trpf}

df_rules_dist_ea_trpf <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_TRPF) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_TRPF_hampel_munic  = dplyr::if_else(!hampel_filter(EA_TRPF), F, T), # Longitudinal (município)
    
    DF_EA_TRPF_out_munic     = dplyr::if_else(!outlier_detection(EA_TRPF), F, T), # Longitudinal (município)
    
    DF_EA_TRPF_min_munic     = dplyr::if_else(EA_TRPF >= (min(dplyr::lag(EA_TRPF), na.rm = T)), F, T), # Longitudinal (município)
     
    DF_EA_TRPF_max_munic     = dplyr::if_else(EA_TRPF <= (max(dplyr::lag(EA_TRPF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPF_min_k_munic   = dplyr::if_else(EA_TRPF >= (min(dplyr::lag(EA_TRPF), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_TRPF_max_k_munic   = dplyr::if_else(EA_TRPF <= (k * max(dplyr::lag(EA_TRPF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPF_med_mov_munic = dplyr::if_else(EA_TRPF <= (k * zoo::rollmedian(EA_TRPF, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_TRPF_dif_munic     = dplyr::if_else(!compare_first_dif(EA_TRPF), F, T) # Longitudinal (município)
)
```

```{r data_wrangling_dist_ea_trpf}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_trpf |> 
  dplyr::select(!EA_TRPF) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_trpf}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_trpf}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_BPCDEF

```{r rules_dist_ea_bpcdef}

df_rules_dist_ea_bpcdef <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_BPCDEF) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_BPCDEF_hampel_munic  = dplyr::if_else(!hampel_filter(EA_BPCDEF), F, T), # Longitudinal (município)
    
    DF_EA_BPCDEF_out_munic     = dplyr::if_else(!outlier_detection(EA_BPCDEF), F, T), # Longitudinal (município)
    
    DF_EA_BPCDEF_min_munic     = dplyr::if_else(EA_BPCDEF >= (min(dplyr::lag(EA_BPCDEF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BPCDEF_max_munic     = dplyr::if_else(EA_BPCDEF <= (max(dplyr::lag(EA_BPCDEF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BPCDEF_min_k_munic   = dplyr::if_else(EA_BPCDEF >= (min(dplyr::lag(EA_BPCDEF), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_BPCDEF_max_k_munic   = dplyr::if_else(EA_BPCDEF <= (k * max(dplyr::lag(EA_BPCDEF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BPCDEF_med_mov_munic = dplyr::if_else(EA_BPCDEF <= (k * zoo::rollmedian(EA_BPCDEF, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_BPCDEF_dif_munic     = dplyr::if_else(!compare_first_dif(EA_BPCDEF), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_bpcdef}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_bpcdef |> 
  dplyr::select(!EA_BPCDEF) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_bpcdef}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_bpcdef}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_BPCIDO

```{r rules_dist_ea_bpcido}

df_rules_dist_ea_bpcido <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_BPCIDO) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_BPCIDO_hampel_munic  = dplyr::if_else(!hampel_filter(EA_BPCIDO), F, T), # Longitudinal (município)
    
    DF_EA_BPCIDO_out_munic     = dplyr::if_else(!outlier_detection(EA_BPCIDO), F, T), # Longitudinal (município)
    
    DF_EA_BPCIDO_min_munic     = dplyr::if_else(EA_BPCIDO >= (min(dplyr::lag(EA_BPCIDO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BPCIDO_max_munic     = dplyr::if_else(EA_BPCIDO <= (max(dplyr::lag(EA_BPCIDO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BPCIDO_min_k_munic   = dplyr::if_else(EA_BPCIDO >= (min(dplyr::lag(EA_BPCIDO), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_BPCIDO_max_k_munic   = dplyr::if_else(EA_BPCIDO <= (k * max(dplyr::lag(EA_BPCIDO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BPCIDO_med_mov_munic = dplyr::if_else(EA_BPCIDO <= (k * zoo::rollmedian(EA_BPCIDO, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_BPCIDO_dif_munic     = dplyr::if_else(!compare_first_dif(EA_BPCIDO), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_bpcido}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_bpcido |> 
  dplyr::select(!EA_BPCIDO) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_bpcido}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_bpcido}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_BFBPC

```{r rules_dist_ea_bfbpc}

df_rules_dist_ea_bfbpc <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_BFBPC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_BFBPC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_BFBPC), F, T), # Longitudinal (município)
    
    DF_EA_BFBPC_out_munic     = dplyr::if_else(!outlier_detection(EA_BFBPC), F, T), # Longitudinal (município)
    
    DF_EA_BFBPC_min_munic     = dplyr::if_else(EA_BFBPC >= (min(dplyr::lag(EA_BFBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BFBPC_max_munic     = dplyr::if_else(EA_BFBPC <= (max(dplyr::lag(EA_BFBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BFBPC_min_k_munic   = dplyr::if_else(EA_BFBPC >= (min(dplyr::lag(EA_BFBPC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_BFBPC_max_k_munic   = dplyr::if_else(EA_BFBPC <= (k * max(dplyr::lag(EA_BFBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_BFBPC_med_mov_munic = dplyr::if_else(EA_BFBPC <= (k * zoo::rollmedian(EA_BFBPC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_BFBPC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_BFBPC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_bfbpc}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_bfbpc |> 
  dplyr::select(!EA_BFBPC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_bfbpc}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_bfbpc}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_TRBPCDEF

```{r rules_dist_ea_trbpcdef}

df_rules_dist_ea_trbpcdef <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_TRBPCDEF) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_TRBPCDEF_hampel_munic  = dplyr::if_else(!hampel_filter(EA_TRBPCDEF), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCDEF_out_munic     = dplyr::if_else(!outlier_detection(EA_TRBPCDEF), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCDEF_min_munic     = dplyr::if_else(EA_TRBPCDEF >= (min(dplyr::lag(EA_TRBPCDEF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCDEF_max_munic     = dplyr::if_else(EA_TRBPCDEF <= (max(dplyr::lag(EA_TRBPCDEF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCDEF_min_k_munic   = dplyr::if_else(EA_TRBPCDEF >= (min(dplyr::lag(EA_TRBPCDEF), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCDEF_max_k_munic   = dplyr::if_else(EA_TRBPCDEF <= (k * max(dplyr::lag(EA_TRBPCDEF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCDEF_med_mov_munic = dplyr::if_else(EA_TRBPCDEF <= (k * zoo::rollmedian(EA_TRBPCDEF, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCDEF_dif_munic     = dplyr::if_else(!compare_first_dif(EA_TRBPCDEF), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_trbpcdef}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_trbpcdef |> 
  dplyr::select(!EA_TRBPCDEF) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_trbpcdef}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_trbpcdef}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_TRBPCIDO

```{r rules_dist_ea_trbpcido}

df_rules_dist_ea_trbpcido <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_TRBPCIDO) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_TRBPCIDO_hampel_munic  = dplyr::if_else(!hampel_filter(EA_TRBPCIDO), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCIDO_out_munic     = dplyr::if_else(!outlier_detection(EA_TRBPCIDO), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCIDO_min_munic     = dplyr::if_else(EA_TRBPCIDO >= (min(dplyr::lag(EA_TRBPCIDO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCIDO_max_munic     = dplyr::if_else(EA_TRBPCIDO <= (max(dplyr::lag(EA_TRBPCIDO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCIDO_min_k_munic   = dplyr::if_else(EA_TRBPCIDO >= (min(dplyr::lag(EA_TRBPCIDO), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCIDO_max_k_munic   = dplyr::if_else(EA_TRBPCIDO <= (k * max(dplyr::lag(EA_TRBPCIDO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCIDO_med_mov_munic = dplyr::if_else(EA_TRBPCIDO <= (k * zoo::rollmedian(EA_TRBPCIDO, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCIDO_dif_munic     = dplyr::if_else(!compare_first_dif(EA_TRBPCIDO), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_trbpcido}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_trbpcido |> 
  dplyr::select(!EA_TRBPCIDO) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_trbpcido}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_trbpcido}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_TRBPC

```{r rules_dist_ea_trbpc}

df_rules_dist_ea_trbpc <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_TRBPC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_TRBPC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_TRBPC), F, T), # Longitudinal (município)
    
    DF_EA_TRBPC_out_munic     = dplyr::if_else(!outlier_detection(EA_TRBPC), F, T), # Longitudinal (município)
    
    DF_EA_TRBPC_min_munic     = dplyr::if_else(EA_TRBPC >= (min(dplyr::lag(EA_TRBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPC_max_munic     = dplyr::if_else(EA_TRBPC <= (max(dplyr::lag(EA_TRBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPC_min_k_munic   = dplyr::if_else(EA_TRBPC >= (min(dplyr::lag(EA_TRBPC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_TRBPC_max_k_munic   = dplyr::if_else(EA_TRBPC <= (k * max(dplyr::lag(EA_TRBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPC_med_mov_munic = dplyr::if_else(EA_TRBPC <= (k * zoo::rollmedian(EA_TRBPC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_TRBPC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_TRBPC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_trbpc}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_trbpc |> 
  dplyr::select(!EA_TRBPC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_trbpc}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_trbpc}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_TRBPCPB

```{r rules_dist_ea_trbpcpb}

df_rules_dist_ea_trbpcpb <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_TRBPCPB) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_TRBPCPB_hampel_munic  = dplyr::if_else(!hampel_filter(EA_TRBPCPB), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCPB_out_munic     = dplyr::if_else(!outlier_detection(EA_TRBPCPB), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCPB_min_munic     = dplyr::if_else(EA_TRBPCPB >= (min(dplyr::lag(EA_TRBPCPB), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCPB_max_munic     = dplyr::if_else(EA_TRBPCPB <= (max(dplyr::lag(EA_TRBPCPB), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCPB_min_k_munic   = dplyr::if_else(EA_TRBPCPB >= (min(dplyr::lag(EA_TRBPCPB), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCPB_max_k_munic   = dplyr::if_else(EA_TRBPCPB <= (k * max(dplyr::lag(EA_TRBPCPB), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCPB_med_mov_munic = dplyr::if_else(EA_TRBPCPB <= (k * zoo::rollmedian(EA_TRBPCPB, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_TRBPCPB_dif_munic     = dplyr::if_else(!compare_first_dif(EA_TRBPCPB), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_trbpcpb}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_trbpcpb |> 
  dplyr::select(!EA_TRBPCPB) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_trbpcpb}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_trbpcpb}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_TRBFBPC

```{r rules_dist_ea_trbfbpc}

df_rules_dist_ea_trbfbpc <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_TRBFBPC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_TRBFBPC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_TRBFBPC), F, T), # Longitudinal (município)
    
    DF_EA_TRBFBPC_out_munic     = dplyr::if_else(!outlier_detection(EA_TRBFBPC), F, T), # Longitudinal (município)
    
    DF_EA_TRBFBPC_min_munic     = dplyr::if_else(EA_TRBFBPC >= (min(dplyr::lag(EA_TRBFBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBFBPC_max_munic     = dplyr::if_else(EA_TRBFBPC <= (max(dplyr::lag(EA_TRBFBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBFBPC_min_k_munic   = dplyr::if_else(EA_TRBFBPC >= (min(dplyr::lag(EA_TRBFBPC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_TRBFBPC_max_k_munic   = dplyr::if_else(EA_TRBFBPC <= (k * max(dplyr::lag(EA_TRBFBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRBFBPC_med_mov_munic = dplyr::if_else(EA_TRBFBPC <= (k * zoo::rollmedian(EA_TRBFBPC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_TRBFBPC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_TRBFBPC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_trbfbpc}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_trbfbpc |> 
  dplyr::select(!EA_TRBFBPC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_trbfbpc}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_trbfbpc}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_TRPC

```{r rules_dist_ea_trpc}

df_rules_dist_ea_trpc <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_TRPC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_TRPC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_TRPC), F, T), # Longitudinal (município)
    
    DF_EA_TRPC_out_munic     = dplyr::if_else(!outlier_detection(EA_TRPC), F, T), # Longitudinal (município)
    
    DF_EA_TRPC_min_munic     = dplyr::if_else(EA_TRPC >= (min(dplyr::lag(EA_TRPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPC_max_munic     = dplyr::if_else(EA_TRPC <= (max(dplyr::lag(EA_TRPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPC_min_k_munic   = dplyr::if_else(EA_TRPC >= (min(dplyr::lag(EA_TRPC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_TRPC_max_k_munic   = dplyr::if_else(EA_TRPC <= (k * max(dplyr::lag(EA_TRPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPC_med_mov_munic = dplyr::if_else(EA_TRPC <= (k * zoo::rollmedian(EA_TRPC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_TRPC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_TRPC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_trpc}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_trpc |> 
  dplyr::select(!EA_TRPC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_trpc}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_trpc}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_TRPCBF

```{r rules_dist_ea_trpcbf}

df_rules_dist_ea_trpcbf <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_TRPCBF) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_TRPCBF_hampel_munic  = dplyr::if_else(!hampel_filter(EA_TRPCBF), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBF_out_munic     = dplyr::if_else(!outlier_detection(EA_TRPCBF), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBF_min_munic     = dplyr::if_else(EA_TRPCBF >= (min(dplyr::lag(EA_TRPCBF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBF_max_munic     = dplyr::if_else(EA_TRPCBF <= (max(dplyr::lag(EA_TRPCBF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBF_min_k_munic   = dplyr::if_else(EA_TRPCBF >= (min(dplyr::lag(EA_TRPCBF), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBF_max_k_munic   = dplyr::if_else(EA_TRPCBF <= (k * max(dplyr::lag(EA_TRPCBF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBF_med_mov_munic = dplyr::if_else(EA_TRPCBF <= (k * zoo::rollmedian(EA_TRPCBF, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBF_dif_munic     = dplyr::if_else(!compare_first_dif(EA_TRPCBF), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_trpcbf}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_trpcbf |> 
  dplyr::select(!EA_TRPCBF) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_trpcbf}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_trpcbf}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_TRPCBPC

```{r rules_dist_ea_trpcbpc}

df_rules_dist_ea_trpcbpc <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_TRPCBPC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_TRPCBPC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_TRPCBPC), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBPC_out_munic     = dplyr::if_else(!outlier_detection(EA_TRPCBPC), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBPC_min_munic     = dplyr::if_else(EA_TRPCBPC >= (min(dplyr::lag(EA_TRPCBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBPC_max_munic     = dplyr::if_else(EA_TRPCBPC <= (max(dplyr::lag(EA_TRPCBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBPC_min_k_munic   = dplyr::if_else(EA_TRPCBPC >= (min(dplyr::lag(EA_TRPCBPC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBPC_max_k_munic   = dplyr::if_else(EA_TRPCBPC <= (k * max(dplyr::lag(EA_TRPCBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBPC_med_mov_munic = dplyr::if_else(EA_TRPCBPC <= (k * zoo::rollmedian(EA_TRPCBPC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_TRPCBPC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_TRPCBPC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_trpcbpc}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_trpcbpc |> 
  dplyr::select(!EA_TRPCBPC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_trpcbpc}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_trpcbpc}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAAGR

```{r rules_dist_ea_vaagr}

df_rules_dist_ea_vaagr <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAAGR) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAAGR_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAAGR), F, T), # Longitudinal (município)
    
    DF_EA_VAAGR_out_munic     = dplyr::if_else(!outlier_detection(EA_VAAGR), F, T), # Longitudinal (município)
    
    DF_EA_VAAGR_min_munic     = dplyr::if_else(EA_VAAGR >= (min(dplyr::lag(EA_VAAGR), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAAGR_max_munic     = dplyr::if_else(EA_VAAGR <= (max(dplyr::lag(EA_VAAGR), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAAGR_min_k_munic   = dplyr::if_else(EA_VAAGR >= (min(dplyr::lag(EA_VAAGR), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAAGR_max_k_munic   = dplyr::if_else(EA_VAAGR <= (k * max(dplyr::lag(EA_VAAGR), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAAGR_med_mov_munic = dplyr::if_else(EA_VAAGR <= (k * zoo::rollmedian(EA_VAAGR, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAAGR_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAAGR), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vaagr}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vaagr |> 
  dplyr::select(!EA_VAAGR) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vaagr}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vaagr}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAIND

```{r rules_dist_ea_vaind}

df_rules_dist_ea_vaind <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAIND) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAIND_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAIND), F, T), # Longitudinal (município)
    
    DF_EA_VAIND_out_munic     = dplyr::if_else(!outlier_detection(EA_VAIND), F, T), # Longitudinal (município)
    
    DF_EA_VAIND_min_munic     = dplyr::if_else(EA_VAIND >= (min(dplyr::lag(EA_VAIND), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAIND_max_munic     = dplyr::if_else(EA_VAIND <= (max(dplyr::lag(EA_VAIND), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAIND_min_k_munic   = dplyr::if_else(EA_VAIND >= (min(dplyr::lag(EA_VAIND), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAIND_max_k_munic   = dplyr::if_else(EA_VAIND <= (k * max(dplyr::lag(EA_VAIND), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAIND_med_mov_munic = dplyr::if_else(EA_VAIND <= (k * zoo::rollmedian(EA_VAIND, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAIND_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAIND), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vaind}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vaind |> 
  dplyr::select(!EA_VAIND) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vaind}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vaind}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAADM

```{r rules_dist_ea_vaadm}

df_rules_dist_ea_vaadm <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAADM) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAADM_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAADM), F, T), # Longitudinal (município)
    
    DF_EA_VAADM_out_munic     = dplyr::if_else(!outlier_detection(EA_VAADM), F, T), # Longitudinal (município)
    
    DF_EA_VAADM_min_munic     = dplyr::if_else(EA_VAADM >= (min(dplyr::lag(EA_VAADM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAADM_max_munic     = dplyr::if_else(EA_VAADM <= (max(dplyr::lag(EA_VAADM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAADM_min_k_munic   = dplyr::if_else(EA_VAADM >= (min(dplyr::lag(EA_VAADM), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAADM_max_k_munic   = dplyr::if_else(EA_VAADM <= (k * max(dplyr::lag(EA_VAADM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAADM_med_mov_munic = dplyr::if_else(EA_VAADM <= (k * zoo::rollmedian(EA_VAADM, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAADM_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAADM), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vaadm}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vaadm |> 
  dplyr::select(!EA_VAADM) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vaadm}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vaadm}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VASERV

```{r rules_dist_ea_vaserv}

df_rules_dist_ea_vaserv <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VASERV) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VASERV_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VASERV), F, T), # Longitudinal (município)
    
    DF_EA_VASERV_out_munic     = dplyr::if_else(!outlier_detection(EA_VASERV), F, T), # Longitudinal (município)
    
    DF_EA_VASERV_min_munic     = dplyr::if_else(EA_VASERV >= (min(dplyr::lag(EA_VASERV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VASERV_max_munic     = dplyr::if_else(EA_VASERV <= (max(dplyr::lag(EA_VASERV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VASERV_min_k_munic   = dplyr::if_else(EA_VASERV >= (min(dplyr::lag(EA_VASERV), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VASERV_max_k_munic   = dplyr::if_else(EA_VASERV <= (k * max(dplyr::lag(EA_VASERV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VASERV_med_mov_munic = dplyr::if_else(EA_VASERV <= (k * zoo::rollmedian(EA_VASERV, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VASERV_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VASERV), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vaserv}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vaserv |> 
  dplyr::select(!EA_VASERV) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vaserv}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vaserv}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAAGR

```{r rules_dist_ea_pvaagr}

df_rules_dist_ea_pvaagr <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAAGR) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAAGR_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAAGR), F, T), # Longitudinal (município)
    
    DF_EA_PVAAGR_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAAGR), F, T), # Longitudinal (município)
    
    DF_EA_PVAAGR_min_munic     = dplyr::if_else(EA_PVAAGR >= (min(dplyr::lag(EA_PVAAGR), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAAGR_max_munic     = dplyr::if_else(EA_PVAAGR <= (max(dplyr::lag(EA_PVAAGR), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAAGR_min_k_munic   = dplyr::if_else(EA_PVAAGR >= (min(dplyr::lag(EA_PVAAGR), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAAGR_max_k_munic   = dplyr::if_else(EA_PVAAGR <= (k * max(dplyr::lag(EA_PVAAGR), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAAGR_med_mov_munic = dplyr::if_else(EA_PVAAGR <= (k * zoo::rollmedian(EA_PVAAGR, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAAGR_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAAGR), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvaagr}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvaagr |> 
  dplyr::select(!EA_PVAAGR) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvaagr}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvaagr}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAIND

```{r rules_dist_ea_pvaind}

df_rules_dist_ea_pvaind <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAIND) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAIND_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAIND), F, T), # Longitudinal (município)
    
    DF_EA_PVAIND_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAIND), F, T), # Longitudinal (município)
    
    DF_EA_PVAIND_min_munic     = dplyr::if_else(EA_PVAIND >= (min(dplyr::lag(EA_PVAIND), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAIND_max_munic     = dplyr::if_else(EA_PVAIND <= (max(dplyr::lag(EA_PVAIND), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAIND_min_k_munic   = dplyr::if_else(EA_PVAIND >= (min(dplyr::lag(EA_PVAIND), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAIND_max_k_munic   = dplyr::if_else(EA_PVAIND <= (k * max(dplyr::lag(EA_PVAIND), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAIND_med_mov_munic = dplyr::if_else(EA_PVAIND <= (k * zoo::rollmedian(EA_PVAIND, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAIND_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAIND), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvaind}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvaind |> 
  dplyr::select(!EA_PVAIND) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvaind}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvaind}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAADM

```{r rules_dist_ea_pvaadm}

df_rules_dist_ea_pvaadm <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAADM) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAADM_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAADM), F, T), # Longitudinal (município)
    
    DF_EA_PVAADM_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAADM), F, T), # Longitudinal (município)
    
    DF_EA_PVAADM_min_munic     = dplyr::if_else(EA_PVAADM >= (min(dplyr::lag(EA_PVAADM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAADM_max_munic     = dplyr::if_else(EA_PVAADM <= (max(dplyr::lag(EA_PVAADM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAADM_min_k_munic   = dplyr::if_else(EA_PVAADM >= (min(dplyr::lag(EA_PVAADM), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAADM_max_k_munic   = dplyr::if_else(EA_PVAADM <= (k * max(dplyr::lag(EA_PVAADM), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAADM_med_mov_munic = dplyr::if_else(EA_PVAADM <= (k * zoo::rollmedian(EA_PVAADM, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAADM_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAADM), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvaadm}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvaadm |> 
  dplyr::select(!EA_PVAADM) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvaadm}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvaadm}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVASERV

```{r rules_dist_ea_pvaserv}

df_rules_dist_ea_pvaserv <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVASERV) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVASERV_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVASERV), F, T), # Longitudinal (município)
    
    DF_EA_PVASERV_out_munic     = dplyr::if_else(!outlier_detection(EA_PVASERV), F, T), # Longitudinal (município)
    
    DF_EA_PVASERV_min_munic     = dplyr::if_else(EA_PVASERV >= (min(dplyr::lag(EA_PVASERV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVASERV_max_munic     = dplyr::if_else(EA_PVASERV <= (max(dplyr::lag(EA_PVASERV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVASERV_min_k_munic   = dplyr::if_else(EA_PVASERV >= (min(dplyr::lag(EA_PVASERV), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVASERV_max_k_munic   = dplyr::if_else(EA_PVASERV <= (k * max(dplyr::lag(EA_PVASERV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVASERV_med_mov_munic = dplyr::if_else(EA_PVASERV <= (k * zoo::rollmedian(EA_PVASERV, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVASERV_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVASERV), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvaserv}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvaserv |> 
  dplyr::select(!EA_PVASERV) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvaserv}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvaserv}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VATOT

```{r rules_dist_ea_vatot}

df_rules_dist_ea_vatot <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VATOT) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VATOT_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VATOT), F, T), # Longitudinal (município)
    
    DF_EA_VATOT_out_munic     = dplyr::if_else(!outlier_detection(EA_VATOT), F, T), # Longitudinal (município)
    
    DF_EA_VATOT_min_munic     = dplyr::if_else(EA_VATOT >= (min(dplyr::lag(EA_VATOT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VATOT_max_munic     = dplyr::if_else(EA_VATOT <= (max(dplyr::lag(EA_VATOT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VATOT_min_k_munic   = dplyr::if_else(EA_VATOT >= (min(dplyr::lag(EA_VATOT), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VATOT_max_k_munic   = dplyr::if_else(EA_VATOT <= (k * max(dplyr::lag(EA_VATOT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VATOT_med_mov_munic = dplyr::if_else(EA_VATOT <= (k * zoo::rollmedian(EA_VATOT, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VATOT_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VATOT), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vatot}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vatot |> 
  dplyr::select(!EA_VATOT) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vatot}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vatot}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_IMPLIQ

```{r rules_dist_ea_impliq}

df_rules_dist_ea_impliq <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_IMPLIQ) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_IMPLIQ_hampel_munic  = dplyr::if_else(!hampel_filter(EA_IMPLIQ), F, T), # Longitudinal (município)
    
    DF_EA_IMPLIQ_out_munic     = dplyr::if_else(!outlier_detection(EA_IMPLIQ), F, T), # Longitudinal (município)
    
    DF_EA_IMPLIQ_min_munic     = dplyr::if_else(EA_IMPLIQ >= (min(dplyr::lag(EA_IMPLIQ), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_IMPLIQ_max_munic     = dplyr::if_else(EA_IMPLIQ <= (max(dplyr::lag(EA_IMPLIQ), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_IMPLIQ_min_k_munic   = dplyr::if_else(EA_IMPLIQ >= (min(dplyr::lag(EA_IMPLIQ), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_IMPLIQ_max_k_munic   = dplyr::if_else(EA_IMPLIQ <= (k * max(dplyr::lag(EA_IMPLIQ), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_IMPLIQ_med_mov_munic = dplyr::if_else(EA_IMPLIQ <= (k * zoo::rollmedian(EA_IMPLIQ, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_IMPLIQ_dif_munic     = dplyr::if_else(!compare_first_dif(EA_IMPLIQ), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_impliq}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_impliq |> 
  dplyr::select(!EA_IMPLIQ) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_impliq}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_impliq}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PIB

```{r rules_dist_ea_pib}

df_rules_dist_ea_pib <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PIB) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PIB_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PIB), F, T), # Longitudinal (município)
    
    DF_EA_PIB_out_munic     = dplyr::if_else(!outlier_detection(EA_PIB), F, T), # Longitudinal (município)
    
    DF_EA_PIB_min_munic     = dplyr::if_else(EA_PIB >= (min(dplyr::lag(EA_PIB), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PIB_max_munic     = dplyr::if_else(EA_PIB <= (max(dplyr::lag(EA_PIB), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PIB_min_k_munic   = dplyr::if_else(EA_PIB >= (min(dplyr::lag(EA_PIB), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PIB_max_k_munic   = dplyr::if_else(EA_PIB <= (k * max(dplyr::lag(EA_PIB), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PIB_med_mov_munic = dplyr::if_else(EA_PIB <= (k * zoo::rollmedian(EA_PIB, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PIB_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PIB), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pib}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pib |> 
  dplyr::select(!EA_PIB) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pib}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pib}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PIBPC

```{r rules_dist_ea_pibpc}

df_rules_dist_ea_pibpc <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PIBPC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PIBPC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PIBPC), F, T), # Longitudinal (município)
    
    DF_EA_PIBPC_out_munic     = dplyr::if_else(!outlier_detection(EA_PIBPC), F, T), # Longitudinal (município)
    
    DF_EA_PIBPC_min_munic     = dplyr::if_else(EA_PIBPC >= (min(dplyr::lag(EA_PIBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PIBPC_max_munic     = dplyr::if_else(EA_PIBPC <= (max(dplyr::lag(EA_PIBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PIBPC_min_k_munic   = dplyr::if_else(EA_PIBPC >= (min(dplyr::lag(EA_PIBPC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PIBPC_max_k_munic   = dplyr::if_else(EA_PIBPC <= (k * max(dplyr::lag(EA_PIBPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PIBPC_med_mov_munic = dplyr::if_else(EA_PIBPC <= (k * zoo::rollmedian(EA_PIBPC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PIBPC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PIBPC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pibpc}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pibpc |> 
  dplyr::select(!EA_PIBPC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pibpc}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pibpc}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAF

```{r rules_dist_ea_vaf}

df_rules_dist_ea_vaf <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAF) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAF_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAF), F, T), # Longitudinal (município)
    
    DF_EA_VAF_out_munic     = dplyr::if_else(!outlier_detection(EA_VAF), F, T), # Longitudinal (município)
    
    DF_EA_VAF_min_munic     = dplyr::if_else(EA_VAF >= (min(dplyr::lag(EA_VAF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAF_max_munic     = dplyr::if_else(EA_VAF <= (max(dplyr::lag(EA_VAF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAF_min_k_munic   = dplyr::if_else(EA_VAF >= (min(dplyr::lag(EA_VAF), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAF_max_k_munic   = dplyr::if_else(EA_VAF <= (k * max(dplyr::lag(EA_VAF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAF_med_mov_munic = dplyr::if_else(EA_VAF <= (k * zoo::rollmedian(EA_VAF, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAF_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAF), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vaf}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vaf |> 
  dplyr::select(!EA_VAF) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vaf}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vaf}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFAG

```{r rules_dist_ea_vafag}

df_rules_dist_ea_vafag <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFAG) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFAG_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFAG), F, T), # Longitudinal (município)
    
    DF_EA_VAFAG_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFAG), F, T), # Longitudinal (município)
    
    DF_EA_VAFAG_min_munic     = dplyr::if_else(EA_VAFAG >= (min(dplyr::lag(EA_VAFAG), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFAG_max_munic     = dplyr::if_else(EA_VAFAG <= (max(dplyr::lag(EA_VAFAG), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFAG_min_k_munic   = dplyr::if_else(EA_VAFAG >= (min(dplyr::lag(EA_VAFAG), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFAG_max_k_munic   = dplyr::if_else(EA_VAFAG <= (k * max(dplyr::lag(EA_VAFAG), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFAG_med_mov_munic = dplyr::if_else(EA_VAFAG <= (k * zoo::rollmedian(EA_VAFAG, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFAG_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFAG), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafag}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafag |> 
  dplyr::select(!EA_VAFAG) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafag}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafag}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFMI

```{r rules_dist_ea_vafmi}

df_rules_dist_ea_vafmi <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFMI) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFMI_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFMI), F, T), # Longitudinal (município)
    
    DF_EA_VAFMI_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFMI), F, T), # Longitudinal (município)
    
    DF_EA_VAFMI_min_munic     = dplyr::if_else(EA_VAFMI >= (min(dplyr::lag(EA_VAFMI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFMI_max_munic     = dplyr::if_else(EA_VAFMI <= (max(dplyr::lag(EA_VAFMI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFMI_min_k_munic   = dplyr::if_else(EA_VAFMI >= (min(dplyr::lag(EA_VAFMI), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFMI_max_k_munic   = dplyr::if_else(EA_VAFMI <= (k * max(dplyr::lag(EA_VAFMI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFMI_med_mov_munic = dplyr::if_else(EA_VAFMI <= (k * zoo::rollmedian(EA_VAFMI, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFMI_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFMI), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafmi}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafmi |> 
  dplyr::select(!EA_VAFMI) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafmi}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafmi}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFIT

```{r rules_dist_ea_vafit}

df_rules_dist_ea_vafit <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFIT) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFIT_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFIT), F, T), # Longitudinal (município)
    
    DF_EA_VAFIT_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFIT), F, T), # Longitudinal (município)
    
    DF_EA_VAFIT_min_munic     = dplyr::if_else(EA_VAFIT >= (min(dplyr::lag(EA_VAFIT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFIT_max_munic     = dplyr::if_else(EA_VAFIT <= (max(dplyr::lag(EA_VAFIT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFIT_min_k_munic   = dplyr::if_else(EA_VAFIT >= (min(dplyr::lag(EA_VAFIT), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFIT_max_k_munic   = dplyr::if_else(EA_VAFIT <= (k * max(dplyr::lag(EA_VAFIT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFIT_med_mov_munic = dplyr::if_else(EA_VAFIT <= (k * zoo::rollmedian(EA_VAFIT, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFIT_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFIT), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafit}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafit |> 
  dplyr::select(!EA_VAFIT) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafit}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafit}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFIC

```{r rules_dist_ea_vafic}

df_rules_dist_ea_vafic <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFIC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFIC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFIC), F, T), # Longitudinal (município)
    
    DF_EA_VAFIC_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFIC), F, T), # Longitudinal (município)
    
    DF_EA_VAFIC_min_munic     = dplyr::if_else(EA_VAFIC >= (min(dplyr::lag(EA_VAFIC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFIC_max_munic     = dplyr::if_else(EA_VAFIC <= (max(dplyr::lag(EA_VAFIC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFIC_min_k_munic   = dplyr::if_else(EA_VAFIC >= (min(dplyr::lag(EA_VAFIC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFIC_max_k_munic   = dplyr::if_else(EA_VAFIC <= (k * max(dplyr::lag(EA_VAFIC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFIC_med_mov_munic = dplyr::if_else(EA_VAFIC <= (k * zoo::rollmedian(EA_VAFIC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFIC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFIC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafic}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafic |> 
  dplyr::select(!EA_VAFIC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafic}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafic}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFUP

```{r rules_dist_ea_vafup}

df_rules_dist_ea_vafup <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFUP) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFUP_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFUP), F, T), # Longitudinal (município)
    
    DF_EA_VAFUP_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFUP), F, T), # Longitudinal (município)
    
    DF_EA_VAFUP_min_munic     = dplyr::if_else(EA_VAFUP >= (min(dplyr::lag(EA_VAFUP), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFUP_max_munic     = dplyr::if_else(EA_VAFUP <= (max(dplyr::lag(EA_VAFUP), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFUP_min_k_munic   = dplyr::if_else(EA_VAFUP >= (min(dplyr::lag(EA_VAFUP), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFUP_max_k_munic   = dplyr::if_else(EA_VAFUP <= (k * max(dplyr::lag(EA_VAFUP), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFUP_med_mov_munic = dplyr::if_else(EA_VAFUP <= (k * zoo::rollmedian(EA_VAFUP, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFUP_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFUP), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafup}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafup |> 
  dplyr::select(!EA_VAFUP) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafup}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafup}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFCV

```{r rules_dist_ea_vafcv}

df_rules_dist_ea_vafcv <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFCV) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFCV_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFCV), F, T), # Longitudinal (município)
    
    DF_EA_VAFCV_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFCV), F, T), # Longitudinal (município)
    
    DF_EA_VAFCV_min_munic     = dplyr::if_else(EA_VAFCV >= (min(dplyr::lag(EA_VAFCV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFCV_max_munic     = dplyr::if_else(EA_VAFCV <= (max(dplyr::lag(EA_VAFCV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFCV_min_k_munic   = dplyr::if_else(EA_VAFCV >= (min(dplyr::lag(EA_VAFCV), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFCV_max_k_munic   = dplyr::if_else(EA_VAFCV <= (k * max(dplyr::lag(EA_VAFCV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFCV_med_mov_munic = dplyr::if_else(EA_VAFCV <= (k * zoo::rollmedian(EA_VAFCV, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFCV_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFCV), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafcv}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafcv |> 
  dplyr::select(!EA_VAFCV) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafcv}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafcv}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFCA

```{r rules_dist_ea_vafca}

df_rules_dist_ea_vafca <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFCA) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFCA_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFCA), F, T), # Longitudinal (município)
    
    DF_EA_VAFCA_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFCA), F, T), # Longitudinal (município)
    
    DF_EA_VAFCA_min_munic     = dplyr::if_else(EA_VAFCA >= (min(dplyr::lag(EA_VAFCA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFCA_max_munic     = dplyr::if_else(EA_VAFCA <= (max(dplyr::lag(EA_VAFCA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFCA_min_k_munic   = dplyr::if_else(EA_VAFCA >= (min(dplyr::lag(EA_VAFCA), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFCA_max_k_munic   = dplyr::if_else(EA_VAFCA <= (k * max(dplyr::lag(EA_VAFCA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFCA_med_mov_munic = dplyr::if_else(EA_VAFCA <= (k * zoo::rollmedian(EA_VAFCA, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFCA_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFCA), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafca}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafca |> 
  dplyr::select(!EA_VAFCA) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafca}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafca}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFSE

```{r rules_dist_ea_vafse}

df_rules_dist_ea_vafse <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFSE) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFSE_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFSE), F, T), # Longitudinal (município)
    
    DF_EA_VAFSE_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFSE), F, T), # Longitudinal (município)
    
    DF_EA_VAFSE_min_munic     = dplyr::if_else(EA_VAFSE >= (min(dplyr::lag(EA_VAFSE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFSE_max_munic     = dplyr::if_else(EA_VAFSE <= (max(dplyr::lag(EA_VAFSE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFSE_min_k_munic   = dplyr::if_else(EA_VAFSE >= (min(dplyr::lag(EA_VAFSE), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFSE_max_k_munic   = dplyr::if_else(EA_VAFSE <= (k * max(dplyr::lag(EA_VAFSE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFSE_med_mov_munic = dplyr::if_else(EA_VAFSE <= (k * zoo::rollmedian(EA_VAFSE, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFSE_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFSE), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafse}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafse |> 
  dplyr::select(!EA_VAFSE) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafse}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafse}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFO

```{r rules_dist_ea_vafo}

df_rules_dist_ea_vafo <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFO) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFO_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFO), F, T), # Longitudinal (município)
    
    DF_EA_VAFO_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFO), F, T), # Longitudinal (município)
    
    DF_EA_VAFO_min_munic     = dplyr::if_else(EA_VAFO >= (min(dplyr::lag(EA_VAFO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFO_max_munic     = dplyr::if_else(EA_VAFO <= (max(dplyr::lag(EA_VAFO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFO_min_k_munic   = dplyr::if_else(EA_VAFO >= (min(dplyr::lag(EA_VAFO), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFO_max_k_munic   = dplyr::if_else(EA_VAFO <= (k * max(dplyr::lag(EA_VAFO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFO_med_mov_munic = dplyr::if_else(EA_VAFO <= (k * zoo::rollmedian(EA_VAFO, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFO_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFO), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafo}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafo |> 
  dplyr::select(!EA_VAFO) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafo}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafo}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAFAG

```{r rules_dist_ea_pvafag}

df_rules_dist_ea_pvafag <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAFAG) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAFAG_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAFAG), F, T), # Longitudinal (município)
    
    DF_EA_PVAFAG_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAFAG), F, T), # Longitudinal (município)
    
    DF_EA_PVAFAG_min_munic     = dplyr::if_else(EA_PVAFAG >= (min(dplyr::lag(EA_PVAFAG), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFAG_max_munic     = dplyr::if_else(EA_PVAFAG <= (max(dplyr::lag(EA_PVAFAG), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFAG_min_k_munic   = dplyr::if_else(EA_PVAFAG >= (min(dplyr::lag(EA_PVAFAG), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAFAG_max_k_munic   = dplyr::if_else(EA_PVAFAG <= (k * max(dplyr::lag(EA_PVAFAG), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFAG_med_mov_munic = dplyr::if_else(EA_PVAFAG <= (k * zoo::rollmedian(EA_PVAFAG, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAFAG_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAFAG), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvafag}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvafag |> 
  dplyr::select(!EA_PVAFAG) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvafag}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvafag}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAFMI

```{r rules_dist_ea_pvafmi}

df_rules_dist_ea_pvafmi <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAFMI) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAFMI_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAFMI), F, T), # Longitudinal (município)
    
    DF_EA_PVAFMI_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAFMI), F, T), # Longitudinal (município)
    
    DF_EA_PVAFMI_min_munic     = dplyr::if_else(EA_PVAFMI >= (min(dplyr::lag(EA_PVAFMI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFMI_max_munic     = dplyr::if_else(EA_PVAFMI <= (max(dplyr::lag(EA_PVAFMI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFMI_min_k_munic   = dplyr::if_else(EA_PVAFMI >= (min(dplyr::lag(EA_PVAFMI), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAFMI_max_k_munic   = dplyr::if_else(EA_PVAFMI <= (k * max(dplyr::lag(EA_PVAFMI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFMI_med_mov_munic = dplyr::if_else(EA_PVAFMI <= (k * zoo::rollmedian(EA_PVAFMI, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAFMI_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAFMI), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvafmi}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvafmi |> 
  dplyr::select(!EA_PVAFMI) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvafmi}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvafmi}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAFIT

```{r rules_dist_ea_pvafit}

df_rules_dist_ea_pvafit <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAFIT) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAFIT_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAFIT), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIT_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAFIT), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIT_min_munic     = dplyr::if_else(EA_PVAFIT >= (min(dplyr::lag(EA_PVAFIT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIT_max_munic     = dplyr::if_else(EA_PVAFIT <= (max(dplyr::lag(EA_PVAFIT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIT_min_k_munic   = dplyr::if_else(EA_PVAFIT >= (min(dplyr::lag(EA_PVAFIT), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIT_max_k_munic   = dplyr::if_else(EA_PVAFIT <= (k * max(dplyr::lag(EA_PVAFIT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIT_med_mov_munic = dplyr::if_else(EA_PVAFIT <= (k * zoo::rollmedian(EA_PVAFIT, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIT_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAFIT), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvafit}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvafit |> 
  dplyr::select(!EA_PVAFIT) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvafit}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvafit}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAFIC

```{r rules_dist_ea_pvafic}

df_rules_dist_ea_pvafic <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAFIC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAFIC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAFIC), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIC_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAFIC), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIC_min_munic     = dplyr::if_else(EA_PVAFIC >= (min(dplyr::lag(EA_PVAFIC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIC_max_munic     = dplyr::if_else(EA_PVAFIC <= (max(dplyr::lag(EA_PVAFIC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIC_min_k_munic   = dplyr::if_else(EA_PVAFIC >= (min(dplyr::lag(EA_PVAFIC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIC_max_k_munic   = dplyr::if_else(EA_PVAFIC <= (k * max(dplyr::lag(EA_PVAFIC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIC_med_mov_munic = dplyr::if_else(EA_PVAFIC <= (k * zoo::rollmedian(EA_PVAFIC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAFIC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAFIC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvafic}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvafic |> 
  dplyr::select(!EA_PVAFIC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvafic}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvafic}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAFUP

```{r rules_dist_ea_pvafup}

df_rules_dist_ea_pvafup <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAFUP) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAFUP_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAFUP), F, T), # Longitudinal (município)
    
    DF_EA_PVAFUP_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAFUP), F, T), # Longitudinal (município)
    
    DF_EA_PVAFUP_min_munic     = dplyr::if_else(EA_PVAFUP >= (min(dplyr::lag(EA_PVAFUP), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFUP_max_munic     = dplyr::if_else(EA_PVAFUP <= (max(dplyr::lag(EA_PVAFUP), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFUP_min_k_munic   = dplyr::if_else(EA_PVAFUP >= (min(dplyr::lag(EA_PVAFUP), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAFUP_max_k_munic   = dplyr::if_else(EA_PVAFUP <= (k * max(dplyr::lag(EA_PVAFUP), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFUP_med_mov_munic = dplyr::if_else(EA_PVAFUP <= (k * zoo::rollmedian(EA_PVAFUP, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAFUP_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAFUP), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvafup}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvafup |> 
  dplyr::select(!EA_PVAFUP) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvafup}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvafup}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAFCV

```{r rules_dist_ea_pvafcv}

df_rules_dist_ea_pvafcv <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAFCV) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAFCV_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAFCV), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCV_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAFCV), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCV_min_munic     = dplyr::if_else(EA_PVAFCV >= (min(dplyr::lag(EA_PVAFCV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCV_max_munic     = dplyr::if_else(EA_PVAFCV <= (max(dplyr::lag(EA_PVAFCV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCV_min_k_munic   = dplyr::if_else(EA_PVAFCV >= (min(dplyr::lag(EA_PVAFCV), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCV_max_k_munic   = dplyr::if_else(EA_PVAFCV <= (k * max(dplyr::lag(EA_PVAFCV), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCV_med_mov_munic = dplyr::if_else(EA_PVAFCV <= (k * zoo::rollmedian(EA_PVAFCV, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCV_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAFCV), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvafcv}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvafcv |> 
  dplyr::select(!EA_PVAFCV) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvafcv}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvafcv}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAFCA

```{r rules_dist_ea_pvafca}

df_rules_dist_ea_pvafca <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAFCA) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAFCA_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAFCA), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCA_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAFCA), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCA_min_munic     = dplyr::if_else(EA_PVAFCA >= (min(dplyr::lag(EA_PVAFCA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCA_max_munic     = dplyr::if_else(EA_PVAFCA <= (max(dplyr::lag(EA_PVAFCA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCA_min_k_munic   = dplyr::if_else(EA_PVAFCA >= (min(dplyr::lag(EA_PVAFCA), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCA_max_k_munic   = dplyr::if_else(EA_PVAFCA <= (k * max(dplyr::lag(EA_PVAFCA), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCA_med_mov_munic = dplyr::if_else(EA_PVAFCA <= (k * zoo::rollmedian(EA_PVAFCA, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAFCA_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAFCA), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvafca}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvafca |> 
  dplyr::select(!EA_PVAFCA) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvafca}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvafca}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAFSE

```{r rules_dist_ea_pvafse}

df_rules_dist_ea_pvafse <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAFSE) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAFSE_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAFSE), F, T), # Longitudinal (município)
    
    DF_EA_PVAFSE_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAFSE), F, T), # Longitudinal (município)
    
    DF_EA_PVAFSE_min_munic     = dplyr::if_else(EA_PVAFSE >= (min(dplyr::lag(EA_PVAFSE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFSE_max_munic     = dplyr::if_else(EA_PVAFSE <= (max(dplyr::lag(EA_PVAFSE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFSE_min_k_munic   = dplyr::if_else(EA_PVAFSE >= (min(dplyr::lag(EA_PVAFSE), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAFSE_max_k_munic   = dplyr::if_else(EA_PVAFSE <= (k * max(dplyr::lag(EA_PVAFSE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFSE_med_mov_munic = dplyr::if_else(EA_PVAFSE <= (k * zoo::rollmedian(EA_PVAFSE, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAFSE_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAFSE), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvafse}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvafse |> 
  dplyr::select(!EA_PVAFSE) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvafse}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvafse}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_PVAFO

```{r rules_dist_ea_pvafo}

df_rules_dist_ea_pvafo <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_PVAFO) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_PVAFO_hampel_munic  = dplyr::if_else(!hampel_filter(EA_PVAFO), F, T), # Longitudinal (município)
    
    DF_EA_PVAFO_out_munic     = dplyr::if_else(!outlier_detection(EA_PVAFO), F, T), # Longitudinal (município)
    
    DF_EA_PVAFO_min_munic     = dplyr::if_else(EA_PVAFO >= (min(dplyr::lag(EA_PVAFO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFO_max_munic     = dplyr::if_else(EA_PVAFO <= (max(dplyr::lag(EA_PVAFO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFO_min_k_munic   = dplyr::if_else(EA_PVAFO >= (min(dplyr::lag(EA_PVAFO), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_PVAFO_max_k_munic   = dplyr::if_else(EA_PVAFO <= (k * max(dplyr::lag(EA_PVAFO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_PVAFO_med_mov_munic = dplyr::if_else(EA_PVAFO <= (k * zoo::rollmedian(EA_PVAFO, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_PVAFO_dif_munic     = dplyr::if_else(!compare_first_dif(EA_PVAFO), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_pvafo}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_pvafo |> 
  dplyr::select(!EA_PVAFO) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_pvafo}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_pvafo}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFPC

```{r rules_dist_ea_vafpc}

df_rules_dist_ea_vafpc <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFPC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFPC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFPC), F, T), # Longitudinal (município)
    
    DF_EA_VAFPC_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFPC), F, T), # Longitudinal (município)
    
    DF_EA_VAFPC_min_munic     = dplyr::if_else(EA_VAFPC >= (min(dplyr::lag(EA_VAFPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFPC_max_munic     = dplyr::if_else(EA_VAFPC <= (max(dplyr::lag(EA_VAFPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFPC_min_k_munic   = dplyr::if_else(EA_VAFPC >= (min(dplyr::lag(EA_VAFPC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFPC_max_k_munic   = dplyr::if_else(EA_VAFPC <= (k * max(dplyr::lag(EA_VAFPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFPC_med_mov_munic = dplyr::if_else(EA_VAFPC <= (k * zoo::rollmedian(EA_VAFPC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFPC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFPC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafpc}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafpc |> 
  dplyr::select(!EA_VAFPC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafpc}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafpc}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_VAFCVPC

```{r rules_dist_ea_vafcvpc}

df_rules_dist_ea_vafcvpc <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_VAFCVPC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_VAFCVPC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_VAFCVPC), F, T), # Longitudinal (município)
    
    DF_EA_VAFCVPC_out_munic     = dplyr::if_else(!outlier_detection(EA_VAFCVPC), F, T), # Longitudinal (município)
    
    DF_EA_VAFCVPC_min_munic     = dplyr::if_else(EA_VAFCVPC >= (min(dplyr::lag(EA_VAFCVPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFCVPC_max_munic     = dplyr::if_else(EA_VAFCVPC <= (max(dplyr::lag(EA_VAFCVPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFCVPC_min_k_munic   = dplyr::if_else(EA_VAFCVPC >= (min(dplyr::lag(EA_VAFCVPC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_VAFCVPC_max_k_munic   = dplyr::if_else(EA_VAFCVPC <= (k * max(dplyr::lag(EA_VAFCVPC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_VAFCVPC_med_mov_munic = dplyr::if_else(EA_VAFCVPC <= (k * zoo::rollmedian(EA_VAFCVPC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_VAFCVPC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_VAFCVPC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_vafcvpc}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_vafcvpc |> 
  dplyr::select(!EA_VAFCVPC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_vafcvpc}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_vafcvpc}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_EMPRSF

```{r rules_dist_ea_emprsf}

df_rules_dist_ea_emprsf <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_EMPRSF) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_EMPRSF_hampel_munic  = dplyr::if_else(!hampel_filter(EA_EMPRSF), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSF_out_munic     = dplyr::if_else(!outlier_detection(EA_EMPRSF), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSF_min_munic     = dplyr::if_else(EA_EMPRSF >= (min(dplyr::lag(EA_EMPRSF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSF_max_munic     = dplyr::if_else(EA_EMPRSF <= (max(dplyr::lag(EA_EMPRSF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSF_min_k_munic   = dplyr::if_else(EA_EMPRSF >= (min(dplyr::lag(EA_EMPRSF), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSF_max_k_munic   = dplyr::if_else(EA_EMPRSF <= (k * max(dplyr::lag(EA_EMPRSF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSF_med_mov_munic = dplyr::if_else(EA_EMPRSF <= (k * zoo::rollmedian(EA_EMPRSF, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSF_dif_munic     = dplyr::if_else(!compare_first_dif(EA_EMPRSF), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_emprsf}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_emprsf |> 
  dplyr::select(!EA_EMPRSF) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_emprsf}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_emprsf}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_EMPRSFTX

```{r rules_dist_ea_emprsftx}

df_rules_dist_ea_emprsftx <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_EMPRSFTX) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_EMPRSFTX_hampel_munic  = dplyr::if_else(!hampel_filter(EA_EMPRSFTX), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFTX_out_munic     = dplyr::if_else(!outlier_detection(EA_EMPRSFTX), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFTX_min_munic     = dplyr::if_else(EA_EMPRSFTX >= (min(dplyr::lag(EA_EMPRSFTX), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFTX_max_munic     = dplyr::if_else(EA_EMPRSFTX <= (max(dplyr::lag(EA_EMPRSFTX), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFTX_min_k_munic   = dplyr::if_else(EA_EMPRSFTX >= (min(dplyr::lag(EA_EMPRSFTX), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFTX_max_k_munic   = dplyr::if_else(EA_EMPRSFTX <= (k * max(dplyr::lag(EA_EMPRSFTX), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFTX_med_mov_munic = dplyr::if_else(EA_EMPRSFTX <= (k * zoo::rollmedian(EA_EMPRSFTX, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFTX_dif_munic     = dplyr::if_else(!compare_first_dif(EA_EMPRSFTX), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_emprsftx}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_emprsftx |> 
  dplyr::select(!EA_EMPRSFTX) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_emprsftx}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_emprsftx}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_RENSF

```{r rules_dist_ea_rensf}

df_rules_dist_ea_rensf <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_RENSF) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_RENSF_hampel_munic  = dplyr::if_else(!hampel_filter(EA_RENSF), F, T), # Longitudinal (município)
    
    DF_EA_RENSF_out_munic     = dplyr::if_else(!outlier_detection(EA_RENSF), F, T), # Longitudinal (município)
    
    DF_EA_RENSF_min_munic     = dplyr::if_else(EA_RENSF >= (min(dplyr::lag(EA_RENSF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_RENSF_max_munic     = dplyr::if_else(EA_RENSF <= (max(dplyr::lag(EA_RENSF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_RENSF_min_k_munic   = dplyr::if_else(EA_RENSF >= (min(dplyr::lag(EA_RENSF), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_RENSF_max_k_munic   = dplyr::if_else(EA_RENSF <= (k * max(dplyr::lag(EA_RENSF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_RENSF_med_mov_munic = dplyr::if_else(EA_RENSF <= (k * zoo::rollmedian(EA_RENSF, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_RENSF_dif_munic     = dplyr::if_else(!compare_first_dif(EA_RENSF), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_rensf}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_rensf |> 
  dplyr::select(!EA_RENSF) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_rensf}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_rensf}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_RENPCSF

```{r rules_dist_ea_renpcsf}

df_rules_dist_ea_renpcsf <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_RENPCSF) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_RENPCSF_hampel_munic  = dplyr::if_else(!hampel_filter(EA_RENPCSF), F, T), # Longitudinal (município)
    
    DF_EA_RENPCSF_out_munic     = dplyr::if_else(!outlier_detection(EA_RENPCSF), F, T), # Longitudinal (município)
    
    DF_EA_RENPCSF_min_munic     = dplyr::if_else(EA_RENPCSF >= (min(dplyr::lag(EA_RENPCSF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_RENPCSF_max_munic     = dplyr::if_else(EA_RENPCSF <= (max(dplyr::lag(EA_RENPCSF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_RENPCSF_min_k_munic   = dplyr::if_else(EA_RENPCSF >= (min(dplyr::lag(EA_RENPCSF), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_RENPCSF_max_k_munic   = dplyr::if_else(EA_RENPCSF <= (k * max(dplyr::lag(EA_RENPCSF), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_RENPCSF_med_mov_munic = dplyr::if_else(EA_RENPCSF <= (k * zoo::rollmedian(EA_RENPCSF, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_RENPCSF_dif_munic     = dplyr::if_else(!compare_first_dif(EA_RENPCSF), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_renpcsf}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_renpcsf |> 
  dplyr::select(!EA_RENPCSF) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_renpcsf}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_renpcsf}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_EMPRSFAG

```{r rules_dist_ea_emprsfag}

df_rules_dist_ea_emprsfag <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_EMPRSFAG) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_EMPRSFAG_hampel_munic  = dplyr::if_else(!hampel_filter(EA_EMPRSFAG), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFAG_out_munic     = dplyr::if_else(!outlier_detection(EA_EMPRSFAG), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFAG_min_munic     = dplyr::if_else(EA_EMPRSFAG >= (min(dplyr::lag(EA_EMPRSFAG), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFAG_max_munic     = dplyr::if_else(EA_EMPRSFAG <= (max(dplyr::lag(EA_EMPRSFAG), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFAG_min_k_munic   = dplyr::if_else(EA_EMPRSFAG >= (min(dplyr::lag(EA_EMPRSFAG), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFAG_max_k_munic   = dplyr::if_else(EA_EMPRSFAG <= (k * max(dplyr::lag(EA_EMPRSFAG), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFAG_med_mov_munic = dplyr::if_else(EA_EMPRSFAG <= (k * zoo::rollmedian(EA_EMPRSFAG, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFAG_dif_munic     = dplyr::if_else(!compare_first_dif(EA_EMPRSFAG), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_emprsfag}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_emprsfag |> 
  dplyr::select(!EA_EMPRSFAG) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_emprsfag}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_emprsfag}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_EMPRSFMI

```{r rules_dist_ea_emprsfmi}

df_rules_dist_ea_emprsfmi <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_EMPRSFMI) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_EMPRSFMI_hampel_munic  = dplyr::if_else(!hampel_filter(EA_EMPRSFMI), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFMI_out_munic     = dplyr::if_else(!outlier_detection(EA_EMPRSFMI), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFMI_min_munic     = dplyr::if_else(EA_EMPRSFMI >= (min(dplyr::lag(EA_EMPRSFMI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFMI_max_munic     = dplyr::if_else(EA_EMPRSFMI <= (max(dplyr::lag(EA_EMPRSFMI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFMI_min_k_munic   = dplyr::if_else(EA_EMPRSFMI >= (min(dplyr::lag(EA_EMPRSFMI), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFMI_max_k_munic   = dplyr::if_else(EA_EMPRSFMI <= (k * max(dplyr::lag(EA_EMPRSFMI), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFMI_med_mov_munic = dplyr::if_else(EA_EMPRSFMI <= (k * zoo::rollmedian(EA_EMPRSFMI, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFMI_dif_munic     = dplyr::if_else(!compare_first_dif(EA_EMPRSFMI), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_emprsfmi}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_emprsfmi |> 
  dplyr::select(!EA_EMPRSFMI) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_emprsfmi}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_emprsfmi}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_EMPRSFIT

```{r rules_dist_ea_emprsfit}

df_rules_dist_ea_emprsfit <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_EMPRSFIT) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_EMPRSFIT_hampel_munic  = dplyr::if_else(!hampel_filter(EA_EMPRSFIT), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIT_out_munic     = dplyr::if_else(!outlier_detection(EA_EMPRSFIT), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIT_min_munic     = dplyr::if_else(EA_EMPRSFIT >= (min(dplyr::lag(EA_EMPRSFIT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIT_max_munic     = dplyr::if_else(EA_EMPRSFIT <= (max(dplyr::lag(EA_EMPRSFIT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIT_min_k_munic   = dplyr::if_else(EA_EMPRSFIT >= (min(dplyr::lag(EA_EMPRSFIT), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIT_max_k_munic   = dplyr::if_else(EA_EMPRSFIT <= (k * max(dplyr::lag(EA_EMPRSFIT), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIT_med_mov_munic = dplyr::if_else(EA_EMPRSFIT <= (k * zoo::rollmedian(EA_EMPRSFIT, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIT_dif_munic     = dplyr::if_else(!compare_first_dif(EA_EMPRSFIT), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_emprsfit}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_emprsfit |> 
  dplyr::select(!EA_EMPRSFIT) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_emprsfit}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_emprsfit}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_EMPRSFUP

```{r rules_dist_ea_emprsfup}

df_rules_dist_ea_emprsfup <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_EMPRSFUP) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_EMPRSFUP_hampel_munic  = dplyr::if_else(!hampel_filter(EA_EMPRSFUP), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFUP_out_munic     = dplyr::if_else(!outlier_detection(EA_EMPRSFUP), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFUP_min_munic     = dplyr::if_else(EA_EMPRSFUP >= (min(dplyr::lag(EA_EMPRSFUP), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFUP_max_munic     = dplyr::if_else(EA_EMPRSFUP <= (max(dplyr::lag(EA_EMPRSFUP), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFUP_min_k_munic   = dplyr::if_else(EA_EMPRSFUP >= (min(dplyr::lag(EA_EMPRSFUP), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFUP_max_k_munic   = dplyr::if_else(EA_EMPRSFUP <= (k * max(dplyr::lag(EA_EMPRSFUP), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFUP_med_mov_munic = dplyr::if_else(EA_EMPRSFUP <= (k * zoo::rollmedian(EA_EMPRSFUP, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFUP_dif_munic     = dplyr::if_else(!compare_first_dif(EA_EMPRSFUP), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_emprsfup}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_emprsfup |> 
  dplyr::select(!EA_EMPRSFUP) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_emprsfup}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_emprsfup}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_EMPRSFIC

```{r rules_dist_ea_emprsfic}

df_rules_dist_ea_emprsfic <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_EMPRSFIC) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_EMPRSFIC_hampel_munic  = dplyr::if_else(!hampel_filter(EA_EMPRSFIC), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIC_out_munic     = dplyr::if_else(!outlier_detection(EA_EMPRSFIC), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIC_min_munic     = dplyr::if_else(EA_EMPRSFIC >= (min(dplyr::lag(EA_EMPRSFIC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIC_max_munic     = dplyr::if_else(EA_EMPRSFIC <= (max(dplyr::lag(EA_EMPRSFIC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIC_min_k_munic   = dplyr::if_else(EA_EMPRSFIC >= (min(dplyr::lag(EA_EMPRSFIC), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIC_max_k_munic   = dplyr::if_else(EA_EMPRSFIC <= (k * max(dplyr::lag(EA_EMPRSFIC), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIC_med_mov_munic = dplyr::if_else(EA_EMPRSFIC <= (k * zoo::rollmedian(EA_EMPRSFIC, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFIC_dif_munic     = dplyr::if_else(!compare_first_dif(EA_EMPRSFIC), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_emprsfic}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_emprsfic |> 
  dplyr::select(!EA_EMPRSFIC) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_emprsfic}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_emprsfic}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_EMPRSFCO

```{r rules_dist_ea_emprsfco}

df_rules_dist_ea_emprsfco <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_EMPRSFCO) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_EMPRSFCO_hampel_munic  = dplyr::if_else(!hampel_filter(EA_EMPRSFCO), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFCO_out_munic     = dplyr::if_else(!outlier_detection(EA_EMPRSFCO), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFCO_min_munic     = dplyr::if_else(EA_EMPRSFCO >= (min(dplyr::lag(EA_EMPRSFCO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFCO_max_munic     = dplyr::if_else(EA_EMPRSFCO <= (max(dplyr::lag(EA_EMPRSFCO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFCO_min_k_munic   = dplyr::if_else(EA_EMPRSFCO >= (min(dplyr::lag(EA_EMPRSFCO), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFCO_max_k_munic   = dplyr::if_else(EA_EMPRSFCO <= (k * max(dplyr::lag(EA_EMPRSFCO), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFCO_med_mov_munic = dplyr::if_else(EA_EMPRSFCO <= (k * zoo::rollmedian(EA_EMPRSFCO, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFCO_dif_munic     = dplyr::if_else(!compare_first_dif(EA_EMPRSFCO), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_emprsfco}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_emprsfco |> 
  dplyr::select(!EA_EMPRSFCO) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_emprsfco}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_emprsfco}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

### EA_EMPRSFSE

```{r rules_dist_ea_emprsfse}

df_rules_dist_ea_emprsfse <- data |> 
  dplyr::select(Ano = ANO, ibge7 = IBGE7, EA_EMPRSFSE) |> 
  dplyr::group_by(ibge7) |> 
  dplyr::mutate(
    DF_EA_EMPRSFSE_hampel_munic  = dplyr::if_else(!hampel_filter(EA_EMPRSFSE), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFSE_out_munic     = dplyr::if_else(!outlier_detection(EA_EMPRSFSE), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFSE_min_munic     = dplyr::if_else(EA_EMPRSFSE >= (min(dplyr::lag(EA_EMPRSFSE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFSE_max_munic     = dplyr::if_else(EA_EMPRSFSE <= (max(dplyr::lag(EA_EMPRSFSE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFSE_min_k_munic   = dplyr::if_else(EA_EMPRSFSE >= (min(dplyr::lag(EA_EMPRSFSE), na.rm = T) / k), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFSE_max_k_munic   = dplyr::if_else(EA_EMPRSFSE <= (k * max(dplyr::lag(EA_EMPRSFSE), na.rm = T)), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFSE_med_mov_munic = dplyr::if_else(EA_EMPRSFSE <= (k * zoo::rollmedian(EA_EMPRSFSE, k = 3, fill = NA, align = "right")), F, T), # Longitudinal (município)
    
    DF_EA_EMPRSFSE_dif_munic     = dplyr::if_else(!compare_first_dif(EA_EMPRSFSE), F, T) # Longitudinal (município)
  )
```

```{r data_wrangling_dist_ea_emprsfse}

## Transformação dos resultados
df_sumario_dist_ea <- df_rules_dist_ea_emprsfse |> 
  dplyr::select(!EA_EMPRSFSE) |> 
  tidyr::pivot_longer(cols = !c(Ano, ibge7), names_to = "Regra", values_to = "resultado")

## df com um sumário dos resultados
df_sumario <- df_sumario_dist_ea |> 
  dplyr::group_by(Ano, Regra) |> 
  dplyr::summarise(
    Total        = dplyr::n(),
    Validada     = sum(!resultado, na.rm = T),
    Suspeita     = sum(resultado, na.rm = T),
    Ausente      = sum(is.na(resultado)),
    `% Validada` = round(Validada / Total * 100, 2),
    `% Suspeita` = round(Suspeita / Total * 100, 2),
    `% Ausente`  = round(Ausente / Total * 100, 2)
  ) |> 
  dplyr::ungroup()
```

```{r table_ea_emprsfse}
#| column: screen-inset-right

df_sumario |>
  dplyr::filter(Ano == max(Ano)) |>
  dplyr::mutate(Ano = as.character(Ano)) |>
  kableExtra::kbl(format.args = list(big.mark = ".", decimal.mark = ",")) |> 
  kableExtra::kable_paper("hover", full_width = F)
```

```{r chart_dist_ea_emprsfse}
#| column: screen-inset-right
#| layout-ncol: 2
#| out-width: 100%

chart_heatmap(df_sumario)
chart_vbar(df_sumario)
```

# Análise descritiva

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi sollicitudin, metus nec rhoncus posuere, leo dolor auctor neque, ut consectetur massa sem et nibh. Vivamus aliquam arcu sed ligula tincidunt, vel iaculis felis accumsan. Fusce in pellentesque erat. In vel euismod justo. Suspendisse imperdiet nulla eget dolor ornare, in viverra massa congue. Suspendisse nec vestibulum lectus. Phasellus venenatis vel turpis ut finibus. Vivamus vehicula neque sem, at ullamcorper magna finibus at. Praesent pulvinar, enim id pellentesque ultricies, magna nibh suscipit magna, at viverra dolor neque vel dolor. Quisque vestibulum orci et ex pharetra, vitae feugiat nulla sollicitudin. Suspendisse posuere aliquet.

## Tabelas

```{r show_desc_table, results='asis'}
#| column: screen-inset-right

pander::pandoc.header("Descritiva", level = 3)

# Loop para mostrar os resultados por variável
for(var in var_numeric){
  pander::pandoc.header(var, level = 4)
  pander::pandoc.table(
    table_descriptive(var), 
    decimal.mark = ",", 
    big.mark     = ".", 
    round        = 2,
    split.table  = Inf
  )
  cat("\\pagebreak\n")
}
```

## Gráficos

::: {.callout-note appearance="minimal"}
Observação: os gráficos abaixo são mostrados na escala logarítmica para facilitar a visualização dos dados em certos casos. Para conferir os valores reais, consultar as tabelas descritivas.
:::

```{r show_boxplot_chart, results='asis'}
#| out-width: 100%
#| fig-format: svg

pander::pandoc.header("Gráfico de caixa (boxplot)", level = 3)

# Loop para mostrar os resultados por variável
for(var in var_numeric){
  pander::pandoc.header(var, level = 4)
  print(chart_boxplot(var))
  cat("\\pagebreak\n")
}
```

```{r show_hist_chart, results='asis'}
#| out-width: 100%
#| fig-format: svg

pander::pandoc.header("Histograma", level = 3)

# Loop para mostrar os resultados por variável
for(var in var_numeric){
  pander::pandoc.header(var, level = 4)
  print(chart_histogram(var))
  cat("\\pagebreak\n")
}
```

```{r excel_create_wb}

## Criar pasta de trabalho
pt <- openxlsx::createWorkbook()
```

```{r df_build_viol_valid}

# Criar base com as observações que violaram uma ou mais regras de validade

## Validade
df_rules_valid_ea_bffam <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_BFFAM")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_trfam <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_TRFAM")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_trpf <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_TRPF")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_bpcdef <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_BPCDEF")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_bpcido <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_BPCIDO")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_bfbpc <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_BFBPC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_trbpcdef <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_TRBPCDEF")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_trbpcido <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_TRBPCIDO")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_trbpc <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_TRBPC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_trbpcpb <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_TRBPCPB")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_trbfbpc <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_TRBFBPC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_trpc <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_TRPC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_trpcbf <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_TRPCBF")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_trpcbpc <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_TRPCBPC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vaagr <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAAGR")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vaind <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAIND")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vaadm <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAADM")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vaserv <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VASERV")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvaagr <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAAGR")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvaind <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAIND")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvaadm <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAADM")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvaserv <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVASERV")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vatot <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VATOT")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_impliq <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_IMPLIQ")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pib <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PIB")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pibpc <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PIBPC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafag <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFAG")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vaf <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAF")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafmi <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFMI")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafit <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFIT")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafic <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFIC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafup <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFUP")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafcv <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFCV")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafca <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFCA")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafse <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFSE")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafo <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFO")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvafag <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAFAG")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvafmi <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAFMI")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvafit <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAFIT")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvafic <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAFIC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvafup <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAFUP")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvafcv <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAFCV")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvafca <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAFCA")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvafse <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAFSE")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_pvafo <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_PVAFO")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafpc <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFPC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_vafcvpc <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_VAFCVPC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_emprsf <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_EMPRSF")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_emprsftx <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_EMPRSFTX")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_rensf <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_RENSF")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_renpcsf <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_RENPCSF")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_emprsfag <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_EMPRSFAG")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_emprsfmi <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_EMPRSFMI")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_emprsfit <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_EMPRSFIT")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_emprsfup <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_EMPRSFUP")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_emprsfic <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_EMPRSFIC")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_emprsfco <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_EMPRSFCO")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_valid_ea_emprsfse <- df_rules_valid_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    dplyr::ends_with("EA_EMPRSFSE")
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)
```

```{r df_export_viol_valid}

## Lista com os dfs por indicador
lista_df <- list(
  "ea_bffam"    = df_rules_valid_ea_bffam,
  "ea_trfam"    = df_rules_valid_ea_trfam,
  "ea_trpf"     = df_rules_valid_ea_trpf,
  "ea_bpcdef"   = df_rules_valid_ea_bpcdef,
  "ea_bpcido"   = df_rules_valid_ea_bpcido,
  "ea_bfbpc"    = df_rules_valid_ea_bfbpc,
  "ea_trbpcdef" = df_rules_valid_ea_trbpcdef,
  "ea_trbpcido" = df_rules_valid_ea_trbpcido,
  "ea_trbpc"    = df_rules_valid_ea_trbpc,
  "ea_trbpcpb"  = df_rules_valid_ea_trbpcpb,
  "ea_trbfbpc"  = df_rules_valid_ea_trbfbpc,
  "ea_trpc"     = df_rules_valid_ea_trpc,
  "ea_trpcbf"   = df_rules_valid_ea_trpcbf,
  "ea_trpcbpc"  = df_rules_valid_ea_trpcbpc,
  "ea_vaagr"    = df_rules_valid_ea_vaagr,
  "ea_vaind"    = df_rules_valid_ea_vaind,
  "ea_vaadm"    = df_rules_valid_ea_vaadm,
  "ea_vaserv"   = df_rules_valid_ea_vaserv,
  "ea_pvaagr"   = df_rules_valid_ea_pvaagr,
  "ea_pvaind"   = df_rules_valid_ea_pvaind,
  "ea_pvaadm"   = df_rules_valid_ea_pvaadm,
  "ea_pvaserv"  = df_rules_valid_ea_pvaserv,
  "ea_vatot"    = df_rules_valid_ea_vatot,
  "ea_impliq"   = df_rules_valid_ea_impliq,
  "ea_pib"      = df_rules_valid_ea_pib,
  "ea_pibpc"    = df_rules_valid_ea_pibpc,
  "ea_vaf"      = df_rules_valid_ea_vaf,
  "ea_vafag"    = df_rules_valid_ea_vafag,
  "ea_vafmi"    = df_rules_valid_ea_vafmi,
  "ea_vafit"    = df_rules_valid_ea_vafit,
  "ea_vafic"    = df_rules_valid_ea_vafic,
  "ea_vafup"    = df_rules_valid_ea_vafup,
  "ea_vafcv"    = df_rules_valid_ea_vafcv,
  "ea_vafca"    = df_rules_valid_ea_vafca,
  "ea_vafse"    = df_rules_valid_ea_vafse,
  "ea_vafo"     = df_rules_valid_ea_vafo,
  "ea_pvafag"   = df_rules_valid_ea_pvafag,
  "ea_pvafmi"   = df_rules_valid_ea_pvafmi,
  "ea_pvafit"   = df_rules_valid_ea_pvafit,
  "ea_pvafic"   = df_rules_valid_ea_pvafic,
  "ea_pvafup"   = df_rules_valid_ea_pvafup,
  "ea_pvafcv"   = df_rules_valid_ea_pvafcv,
  "ea_pvafca"   = df_rules_valid_ea_pvafca,
  "ea_pvafse"   = df_rules_valid_ea_pvafse,
  "ea_pvafo"    = df_rules_valid_ea_pvafo,
  "ea_vafpc"    = df_rules_valid_ea_vafpc,
  "ea_vafcvpc"  = df_rules_valid_ea_vafcvpc,
  "ea_emprsf"   = df_rules_valid_ea_emprsf,
  "ea_emprsftx" = df_rules_valid_ea_emprsftx,
  "ea_rensf"    = df_rules_valid_ea_rensf,
  "ea_renpcsf"  = df_rules_valid_ea_renpcsf,
  "ea_emprsfag" = df_rules_valid_ea_emprsfag,
  "ea_emprsfmi" = df_rules_valid_ea_emprsfmi,
  "ea_emprsfit" = df_rules_valid_ea_emprsfit,
  "ea_emprsfup" = df_rules_valid_ea_emprsfup,
  "ea_emprsfic" = df_rules_valid_ea_emprsfic,
  "ea_emprsfco" = df_rules_valid_ea_emprsfco,
  "ea_emprsfse" = df_rules_valid_ea_emprsfse
)

## Add dados à pasta de trabalho
for(i in names(lista_df)){
  nome <- stringr::str_remove(i, "df_rules_valid_")
  openxlsx::addWorksheet(pt, paste0("valid - ", nome))
  openxlsx::writeData(pt, paste0("valid - ", nome), lista_df[[i]])
}
```

```{r df_build_viol_consist}

# Criar base com as observações que violaram uma ou mais regras de consistência

## Consistência
df_rules_consist_ea_va_total <- df_rules_consist_ea_all |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_consist_ea_vaf_total <- df_rules_consist_ea_all |> 
  dplyr::select(
    Ano,
    ibge7,
    EA_PVAFAG:EA_PVAFO, 
    CI_VAF_total_munic
  ) |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)
```

```{r df_export_viol_consist}

## Lista com os dfs por indicador
lista_df <- list(
  "ea_va_total"  = df_rules_consist_ea_va_total,
  "ea_vaf_total" = df_rules_consist_ea_vaf_total
)

## Add dados à pasta de trabalho
for(i in names(lista_df)){
  nome <- stringr::str_remove(i, "df_rules_consist_")
  openxlsx::addWorksheet(pt, paste0("consist - ", nome))
  openxlsx::writeData(pt, paste0("consist - ", nome), lista_df[[i]])
}
```

```{r df_build_viol_dist}

# Criar base com as observações que violaram uma ou mais regras de distribuição

## Distribuição
df_rules_dist_ea_bffam <- df_rules_dist_ea_bffam |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_trfam <- df_rules_dist_ea_trfam |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_trpf <- df_rules_dist_ea_trpf |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_bpcdef <- df_rules_dist_ea_bpcdef |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_bpcido <- df_rules_dist_ea_bpcido |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_bfbpc <- df_rules_dist_ea_bfbpc |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_trbpcdef <- df_rules_dist_ea_trbpcdef |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_trbpcido <- df_rules_dist_ea_trbpcido |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_trbpc <- df_rules_dist_ea_trbpc |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_trbpcpb <- df_rules_dist_ea_trbpcpb |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_trbfbpc <- df_rules_dist_ea_trbfbpc |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_trpc <- df_rules_dist_ea_trpc |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_trpcbf <- df_rules_dist_ea_trpcbf |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_trpcbpc <- df_rules_dist_ea_trpcbpc |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vaagr <- df_rules_dist_ea_vaagr |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vaind <- df_rules_dist_ea_vaind |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vaadm <- df_rules_dist_ea_vaadm |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vaserv <- df_rules_dist_ea_vaserv |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvaagr <- df_rules_dist_ea_pvaagr |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvaind <- df_rules_dist_ea_pvaind |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvaadm <- df_rules_dist_ea_pvaadm |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvaserv <- df_rules_dist_ea_pvaserv |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vatot <- df_rules_dist_ea_vatot |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_impliq <- df_rules_dist_ea_impliq |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pib <- df_rules_dist_ea_pib |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pibpc <- df_rules_dist_ea_pibpc |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafag <- df_rules_dist_ea_vafag  |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vaf <- df_rules_dist_ea_vaf |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafmi <- df_rules_dist_ea_vafmi |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafit <- df_rules_dist_ea_vafit |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafic <- df_rules_dist_ea_vafic |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafup <- df_rules_dist_ea_vafup |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafcv <- df_rules_dist_ea_vafcv |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafca <- df_rules_dist_ea_vafca |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafse <- df_rules_dist_ea_vafse |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafo <- df_rules_dist_ea_vafo |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvafag <- df_rules_dist_ea_pvafag |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvafmi <- df_rules_dist_ea_pvafmi |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvafit <- df_rules_dist_ea_pvafit |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvafic <- df_rules_dist_ea_pvafic |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvafup <- df_rules_dist_ea_pvafup |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvafcv <- df_rules_dist_ea_pvafcv |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvafca <- df_rules_dist_ea_pvafca |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvafse <- df_rules_dist_ea_pvafse |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_pvafo <- df_rules_dist_ea_pvafo |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafpc <- df_rules_dist_ea_vafpc |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_vafcvpc <- df_rules_dist_ea_vafcvpc |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_emprsf <- df_rules_dist_ea_emprsf |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_emprsftx <- df_rules_dist_ea_emprsftx |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_rensf <- df_rules_dist_ea_rensf |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_renpcsf <- df_rules_dist_ea_renpcsf |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_emprsfag <- df_rules_dist_ea_emprsfag |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_emprsfmi <- df_rules_dist_ea_emprsfmi |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_emprsfit <- df_rules_dist_ea_emprsfit |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_emprsfup <- df_rules_dist_ea_emprsfup |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_emprsfic <- df_rules_dist_ea_emprsfic |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_emprsfco <- df_rules_dist_ea_emprsfco |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)

df_rules_dist_ea_emprsfse <- df_rules_dist_ea_emprsfse |> 
  tidyr::pivot_longer(
    cols      = !c(Ano, ibge7, dplyr::starts_with("EA_")), 
    names_to  = "regra", 
    values_to = "obs_suspeita"
  ) |> 
  dplyr::filter(obs_suspeita) |> 
  dplyr::rename_with(tolower) |> 
  dplyr::arrange(ano, ibge7)
```

```{r df_export_viol_dist}

## Lista com os dfs por indicador
lista_df <- list(
  "ea_bffam"    = df_rules_dist_ea_bffam,
  "ea_trfam"    = df_rules_dist_ea_trfam,
  "ea_trpf"     = df_rules_dist_ea_trpf,
  "ea_bpcdef"   = df_rules_dist_ea_bpcdef,
  "ea_bpcido"   = df_rules_dist_ea_bpcido,
  "ea_bfbpc"    = df_rules_dist_ea_bfbpc,
  "ea_trbpcdef" = df_rules_dist_ea_trbpcdef,
  "ea_trbpcido" = df_rules_dist_ea_trbpcido,
  "ea_trbpc"    = df_rules_dist_ea_trbpc,
  "ea_trbpcpb"  = df_rules_dist_ea_trbpcpb,
  "ea_trbfbpc"  = df_rules_dist_ea_trbfbpc,
  "ea_trpc"     = df_rules_dist_ea_trpc,
  "ea_trpcbf"   = df_rules_dist_ea_trpcbf,
  "ea_trpcbpc"  = df_rules_dist_ea_trpcbpc,
  "ea_vaagr"    = df_rules_dist_ea_vaagr,
  "ea_vaind"    = df_rules_dist_ea_vaind,
  "ea_vaadm"    = df_rules_dist_ea_vaadm,
  "ea_vaserv"   = df_rules_dist_ea_vaserv,
  "ea_pvaagr"   = df_rules_dist_ea_pvaagr,
  "ea_pvaind"   = df_rules_dist_ea_pvaind,
  "ea_pvaadm"   = df_rules_dist_ea_pvaadm,
  "ea_pvaserv"  = df_rules_dist_ea_pvaserv,
  "ea_vatot"    = df_rules_dist_ea_vatot,
  "ea_impliq"   = df_rules_dist_ea_impliq,
  "ea_pib"      = df_rules_dist_ea_pib,
  "ea_pibpc"    = df_rules_dist_ea_pibpc,
  "ea_vaf"      = df_rules_dist_ea_vaf,
  "ea_vafag"    = df_rules_dist_ea_vafag,
  "ea_vafmi"    = df_rules_dist_ea_vafmi,
  "ea_vafit"    = df_rules_dist_ea_vafit,
  "ea_vafic"    = df_rules_dist_ea_vafic,
  "ea_vafup"    = df_rules_dist_ea_vafup,
  "ea_vafcv"    = df_rules_dist_ea_vafcv,
  "ea_vafca"    = df_rules_dist_ea_vafca,
  "ea_vafse"    = df_rules_dist_ea_vafse,
  "ea_vafo"     = df_rules_dist_ea_vafo,
  "ea_pvafag"   = df_rules_dist_ea_pvafag,
  "ea_pvafmi"   = df_rules_dist_ea_pvafmi,
  "ea_pvafit"   = df_rules_dist_ea_pvafit,
  "ea_pvafic"   = df_rules_dist_ea_pvafic,
  "ea_pvafup"   = df_rules_dist_ea_pvafup,
  "ea_pvafcv"   = df_rules_dist_ea_pvafcv,
  "ea_pvafca"   = df_rules_dist_ea_pvafca,
  "ea_pvafse"   = df_rules_dist_ea_pvafse,
  "ea_pvafo"    = df_rules_dist_ea_pvafo,
  "ea_vafpc"    = df_rules_dist_ea_vafpc,
  "ea_vafcvpc"  = df_rules_dist_ea_vafcvpc,
  "ea_emprsf"   = df_rules_dist_ea_emprsf,
  "ea_emprsftx" = df_rules_dist_ea_emprsftx,
  "ea_rensf"    = df_rules_dist_ea_rensf,
  "ea_renpcsf"  = df_rules_dist_ea_renpcsf,
  "ea_emprsfag" = df_rules_dist_ea_emprsfag,
  "ea_emprsfmi" = df_rules_dist_ea_emprsfmi,
  "ea_emprsfit" = df_rules_dist_ea_emprsfit,
  "ea_emprsfup" = df_rules_dist_ea_emprsfup,
  "ea_emprsfic" = df_rules_dist_ea_emprsfic,
  "ea_emprsfco" = df_rules_dist_ea_emprsfco,
  "ea_emprsfse" = df_rules_dist_ea_emprsfse
)

for(i in names(lista_df)){
  nome <- stringr::str_remove(i, "df_rules_dist_")
  openxlsx::addWorksheet(pt, paste0("distrib - ", nome))
  openxlsx::writeData(pt, paste0("distrib - ", nome), lista_df[[i]])
}
```

```{r excel_save_wb}

openxlsx::saveWorkbook(pt, "fjpdados_economia_violacoes.xlsx", overwrite = T)
```

```{r clean_env, results='hide'}

rm(list = ls())
gc()
```
